PS D:\Study\GraduationProject\fe_graduation_v2> cd src 
PS D:\Study\GraduationProject\fe_graduation_v2\src> tree /f
Folder PATH listing for volume New Volume
Volume serial number is 7C5B-6CE0
D:.
│   App.css
│   App.tsx
│   index.css
│   main.tsx
│   vite-env.d.ts
│   
├───api
│       authApi.ts
│       blogApi.ts
│       cartApi.ts
│       courseApi.ts
│       orderApi.ts
│       paymentApi.ts
│       userApi.ts
│
├───assets
│       avt.jpg
│       logo.svg
│       react.svg
│
├───components
│   ├───common
│   │   ├───Auth
│   │   │   ├───LoginModal
│   │   │   │       LoginModal.css
│   │   │   │       LoginModal.tsx
│   │   │   │
│   │   │   └───RegisterModal
│   │   │           RegisterModal.css
│   │   │           RegisterModal.tsx
│   │   │
│   │   ├───CartBadge
│   │   │       CartBadge.css
│   │   │       CartBadge.tsx
│   │   │
│   │   ├───Dashboard
│   │   │   ├───Navigation
│   │   │   │       Navigation.css
│   │   │   │       Navigation.tsx
│   │   │   │
│   │   │   └───Profile
│   │   │       └───ProfileCard
│   │   │               ProfileCard.css
│   │   │               ProfileCard.tsx
│   │   │
│   │   ├───Notification
│   │   │       Notification.css
│   │   │       Notification.tsx
│   │   │
│   │   ├───ProtectedRoute
│   │   │       ProtectedRoute.css
│   │   │       ProtectedRoute.tsx
│   │   │
│   │   ├───PurchaseButtons
│   │   │       PurchaseButtons.css
│   │   │       PurchaseButtons.tsx
│   │   │
│   │   ├───TipTapEditor
│   │   │       TipTapEditor.css
│   │   │       TipTapEditor.tsx
│   │   │
│   │   └───UserMenu
│   │           UserMenu.css
│   │           UserMenu.tsx
│   │
│   ├───manage
│   │   └───CourseManagement
│   │       └───CourseDetailDrawer
│   │               CourseDetailDrawer.css
│   │               CourseDetailDrawer.tsx
│   │
│   ├───public-page
│   ├───student
│   │   ├───Cart
│   │   │       CartDrawer.css
│   │   │       CartDrawer.tsx
│   │   │
│   │   ├───Course
│   │   │   └───CourseCard
│   │   └───Order
│   │       ├───OrderCard
│   │       │       OrderCard.css
│   │       │       OrderCard.tsx
│   │       │
│   │       └───PurchaseModal
│   │               PurchaseModal.css
│   │               PurchaseModal.tsx
│   │
│   └───teacher
├───constants
│       categories.ts
│       permissions.ts
│
├───hooks
├───layouts
│   └───MainLayout
│           MainLayout.css
│           MainLayout.tsx
│
├───lib
│       axios.ts
│
├───pages
│   ├───common
│   │   ├───Dashboard
│   │   │       Dashboard.css
│   │   │       Dashboard.tsx
│   │   │
│   │   └───Profile
│   │           Profile.css
│   │           Profile.tsx
│   │
│   ├───manage
│   │   ├───BlogApproval
│   │   │       BlogApproval.css
│   │   │       BlogApproval.tsx
│   │   │
│   │   ├───Business
│   │   │       Business.css
│   │   │       Business.tsx
│   │   │
│   │   ├───ClassManagement
│   │   │       ClassManagement.css
│   │   │       ClassManagement.tsx
│   │   │
│   │   ├───CourseManagement
│   │   │       CourseManagement.css
│   │   │       CourseManagement.tsx
│   │   │
│   │   ├───MemberManagement
│   │   │       MemberManagement.css
│   │   │       MemberManagement.tsx
│   │   │
│   │   ├───QuestionBank
│   │   │       QuestionBank.css
│   │   │       QuestionBank.tsx
│   │   │
│   │   ├───Statistics
│   │   │       Statistics.css
│   │   │       Statistics.tsx
│   │   │
│   │   └───WriteBlog
│   │           WriteBlog.css
│   │           WriteBlog.tsx
│   │
│   ├───public-page
│   │   ├───Blog
│   │   │       Blog.tsx
│   │   │
│   │   ├───Courses
│   │   │       Course.tsx
│   │   │
│   │   ├───Home
│   │   │       Home.css
│   │   │       Home.tsx
│   │   │
│   │   └───Test
│   │           Test.tsx
│   │
│   ├───student
│   │   ├───Cart
│   │   │       Cart.css
│   │   │       Cart.tsx
│   │   │
│   │   ├───Orders
│   │   │       Orders.css
│   │   │       Orders.tsx
│   │   │
│   │   ├───OrderStatus
│   │   │       OrderStatus.css
│   │   │       OrderStatus.tsx
│   │   │
│   │   └───VideoCourses
│   │           VideoCourses.css
│   │           VideoCourses.tsx
│   │
│   └───teacher
│       └───OfflineClasses
│               OfflineClasses.css
│               OfflineClasses.tsx
│
├───routes
│       index.ts
│
├───services
│       authService.ts
│       blogService.ts
│       businessService.ts
│       cartService.ts
│       courseManagementService.ts
│       memberManagementService.ts
│       orderService.ts
│       paymentService.ts
│       questionBankService.ts
│       statisticsService.ts
│       userService.ts
│
├───store
│       authStore.ts
│       cartStore.ts
│       orderStore.ts
│
└───types
        auth.ts
        blog.ts
        cart.ts
        course.ts
        css.d.ts
        order.ts
        payment.ts
        svg.d.ts
        user.ts

PS D:\Study\GraduationProject\fe_graduation_v2\src> 

export interface User {
  id: number;
  firstName: string;
  lastName: string;
  phone: string;
  address: string;
  dob: string;
  gender: string;
  avatarUrl: string;
  isActive: boolean;
  isDelete: boolean;
  education: string;
  major: string;
  role: string;
  student?: {
    education: string;
    major: string;
  };
  createdAt?: string;
  updatedAt?: string;
}

export interface FilterRequest {
  searchString?: string;
  email?: string;
  name?: string;
  phone?: string;
  isActive?: boolean;
  isDelete?: boolean;
  userRoles?: string[] | null;
  fromDate?: string;
  toDate?: string;
  title?: string;
  categoryPost?: string[];
  categories?: string[];
  page?: number;
  size?: number;
  sort?: string | null;
}

export interface FilterResponse {
  code: number;
  message: string;
  data: {
    totalPages: number;
    totalElements: number;
    size: number;
    content: User[];
    number: number;
    sort: {
      empty: boolean;
      unsorted: boolean;
      sorted: boolean;
    };
    pageable: {
      offset: number;
      sort: {
        empty: boolean;
        unsorted: boolean;
        sorted: boolean;
      };
      unpaged: boolean;
      paged: boolean;
      pageNumber: number;
      pageSize: number;
    };
    first: boolean;
    last: boolean;
    empty: boolean;
  };
}

export interface DisableUserRequest {
  id: number;
  isActive: boolean;
}

export interface DisableUserResponse {
  code: number;
  message: string;
  data: User;
}

export interface DeleteUserRequest {
  id: number;
  isDelete: boolean;
  isActive: boolean;
}

export interface DeleteUserResponse {
  code: number;
  message: string;
  data: User;
}

export interface UserProfileResponse {
  code: number;
  message: string;
  data: {
    id: string;
    firstName: string;
    lastName: string;
    phone: string | null;
    address: string | null;
    dob: string | null;
    gender: string | null;
    avatarUrl: string | null;
    isActive: boolean | null;
    isDelete: boolean | null;
    education: string | null;
    major: string | null;
    student: any | null;
  };
}

export interface UpdateUserInfoRequest {
  // id: number;
  // email?: string;
  // password?: string;
  // oldPassword?: string;
  firstName?: string;
  lastName?: string;
  phone?: string;
  address?: string;
  dob?: string;
  gender?: string;
  avatarUrl?: string;
  education?: string;
  major?: string;
  isActive?: boolean;
  isDelete?: boolean;
  token?: string;
}

export interface UpdateUserInfoResponse {
  code: number;
  message: string;
  data: User;
}export interface PaymentResponse {
  code: number;
  message: string;
  data: {
    status: string;
    url: string;
    message: string;
  }
}

export interface PaymentStatusQuery {
  status: string;
  txnRef: string;
  transactionNo: string;
  amount: string;
  payDate: string;
}
// types/order.ts
import type { Course } from './course';

/**
 * ✅ ORDER DETAIL - Chi tiết khóa học trong đơn hàng
 * Từ API response: order.detail
 */
export interface OrderDetail {
  id: number;                    // ID của order detail
  priceAtPurchase: number;       // Giá tại thời điểm mua (có thể khác giá hiện tại)
  course: Course;                // Thông tin khóa học đầy đủ
}

/**
 * ✅ ORDER - Đơn hàng chính
 * Từ API response mẫu
 */
export interface Order {
  id: number;                    // ID đơn hàng
  totalAmount: number | null;    // Tổng tiền (có thể null nếu chưa tính)
  paymentMethod: string;         // "VN_PAY" | "MOMO" | "BANK_TRANSFER"
  transactionCode: string | null; // Mã giao dịch (có thể null nếu chưa thanh toán)
  createdAt: string;             // Ngày tạo đơn hàng
  updatedAt: string | null;      // Ngày cập nhật cuối
  status: string;                // "PENDING" | "COMPLETED" | "CANCELLED" | "FAILED"
  detail: OrderDetail;           // Chi tiết đơn hàng
}

/**
 * ✅ GET ORDERS RESPONSE
 * GET /api/v1/order
 */
export interface OrderResponse {
  code: number;                  // 200 = success
  message: string;               // "Get Order is successfully"
  data: Order[];                 // Array của orders
}

/**
 * ✅ CREATE ORDER RESPONSE  
 * POST /api/v1/order/create-order-by-course
 * POST /api/v1/order/create-order-by-cart-item
 */
export interface CreateOrderResponse {
  code: number;                  // 200 = success
  message: string;               // "Order has been created"
  data: Order;                   // Order vừa tạo
}

/**
 * ✅ DELETE ORDER RESPONSE
 * DELETE /api/v1/order/delete
 */
export interface DeleteOrderResponse {
  code: number;                  // 200 = success  
  message: string;               // "Order has been deleted"
  data: null;                    // Không trả về data
}

/**
 * ✅ UNION TYPES cho type safety
 */
export type PaymentMethod = 'VN_PAY' | 'MOMO' | 'BANK_TRANSFER';

export type OrderStatus = 'PENDING' | 'COMPLETED' | 'CANCELLED' | 'FAILED';

/**
 * ✅ ORDER SUMMARY cho UI (computed values)
 */
export interface OrderSummary {
  totalOrders: number;           // Tổng số đơn hàng
  pendingOrders: number;         // Đơn hàng đang chờ
  completedOrders: number;       // Đơn hàng hoàn thành
  cancelledOrders: number;       // Đơn hàng đã hủy
  totalSpent: number;            // Tổng tiền đã chi tiêu
}

/**
 * ✅ ORDER FILTER cho search/filter functionality
 */
export interface OrderFilter {
  status?: OrderStatus[];        // Filter theo status
  paymentMethod?: PaymentMethod[]; // Filter theo payment method
  dateRange?: [string, string];  // Filter theo khoảng thời gian
  searchQuery?: string;          // Search theo tên khóa học hoặc order ID
}// types/course.ts - Cải thiện
export interface AllCoursesRequest {
  fromDate: string | null;
  toDate: string | null;
  title: string | null;
  categories: string[];
  page?: number;
  size?: number;
  sort?: string | null;
}

export interface Course {
  id: number;
  title: string;
  description: string;
  price: number;
  thumbnailUrl: string | null;
  categoryName: string | null;
  categoryId?: number; // ✅ Thêm categoryId - từ backend response
  updatedAt: string | null;
  createdAt: string;
  isDelete: boolean;
  isActive: boolean;
  isBought: boolean | null;
  authorName: string | null;
  createdByName: string | null;
  updatedByName: string | null;
  author: Author | null;
  createdBy: Author | null;
  updatedBy: Author | null;
  lessons: Lesson[] | null;
}

// ✅ Thêm interface cho Author từ API response
export interface Author {
  id: number;
  firstName: string;
  lastName: string;
  phone: string | null;
  address: string | null;
  dob: string | null;
  gender: string | null;
  avatarUrl: string | null;
  isActive: boolean;
  isDelete: boolean;
  education: string | null;
  major: string | null;
  role: string;
  student: any | null;
  consultant: any | null;
  teacher: any | null;
  manager: any | null;
  createdAt: string;
  updatedAt: string | null;
  code: string;
}

// ✅ Thêm interface cho Lesson từ API response
export interface Lesson {
  id: number;
  title: string;
  content: string;
  videoUrl: string;
  duration: number;
  orderIndex: number;
  isPreviewAble: boolean;
  courseId: string;
  isBought: boolean;
  isDeleted: boolean;
  isActive: boolean;
  createdAt: string;
  updatedAt: string | null;
  createdBy: Author | null;
  updatedBy: Author | null;
  createdByName: string | null;
  updatedByName: string | null;
}

export interface CourseResponse {
  code: number;
  message: string;
  data: {
    content: Course[];
    pageable: {
      pageNumber: number;
      pageSize: number;
      sort: {
        empty: boolean;
        sorted: boolean;
        unsorted: boolean;
      };
      offset: number;
      paged: boolean;
      unpaged: boolean;
    };
    totalPages: number;
    totalElements: number;
    last: boolean;
    size: number;
    number: number;
    sort: {
      empty: boolean;
      sorted: boolean;
      unsorted: boolean;
    };
    numberOfElements: number;
    first: boolean;
    empty: boolean;
  };
}

export interface CourseDetailResponse {
  code: number;
  message: string;
  data: Course;
}

export interface CourseCreateRequest {
  title: string;
  description: string;
  price: number;
  authorId: number;
  categoryId: number;
  thumbnailUrl: string;
  isActive?: boolean; // ✅ Optional với default
  isDelete?: boolean; // ✅ Optional với default
}

export interface CourseUpdateRequest {
  id: number;
  title?: string; // ✅ Optional cho update
  description?: string; // ✅ Optional cho update
  price?: number; // ✅ Optional cho update
  categoryId?: number; // ✅ Optional cho update
  thumbnailUrl?: string; // ✅ Optional cho update
  isActive?: boolean; // ✅ Optional cho update
  isDelete?: boolean; // ✅ Optional cho update
}

// ✅ Thêm interface riêng cho status update
export interface CourseStatusUpdateRequest {
  id: number;
  isActive?: boolean;
  isDelete?: boolean;
}

export interface UploadResponse {
  code: number;
  message: string;
  data: string;
}

export interface Category {
  id: number;
  name: string;
}

export interface CategoryResponse {
  code: number;
  message: string;
  data: Category[];
}import type { Course } from "./course";

export interface CartItem{
  id: number;
  course: Course;
  createdAt: string | null;
}

//get all
export interface CartResponse {
  code: number;
  message: string;
  data: CartItem[]
}

//add
export interface AddToCartRequest {
  id: number;
}
export interface AddToCartResponse{
  code: number;
  message: string;
  data: null;
}

//remove
export interface RemoveFromCartRequest{
  id: number;
}
export interface RemoveFromCartResponse{
  code: number;
  message: string;
  data: null;
}

// ✅ Type cho cart summary (tính toán local)
export interface CartSummary {
  itemCount: number;      // Số lượng items
  totalAmount: number;    // Tổng tiền
  isEmpty: boolean;       // Giỏ hàng có rỗng không
}

// ✅ Type cho cart operations state (UI loading states)
export interface CartOperationState {
  addingToCart: boolean;  // Đang thêm vào giỏ hàng
  removingFromCart: boolean; // Đang xóa khỏi giỏ hàng
  loading: boolean;       // Đang load cart data
  error: string | null;   // Lỗi nếu có
}





export interface RegisterRequest {
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  role?: number;
}

export interface LoginRequest {
  email: string;
  password: string;
}

export interface AuthResponse {
  code: number;
  message: string;
  data: {
    token: string;
    authenticated: boolean;
    role: number;
  } | null;
}

export interface LogoutResponse {
  code: number;
  message: string;
  data: null;
}

export interface UserProfileResponse {
  code: number;
  message: string;
  data: {
    firstName: string;
    lastName: string;
    phone: string | null;
    address: string | null;
    dob: string | null;
    gender: string | null;
    avatarUrl: string | null;
    isActive: boolean | null;
    isDelete: boolean | null;
    education: string | null;
    major: string | null;
    student: any | null;
  };
}

export interface PostData {
  title: string;
  content: string;
  themeUrl: string;
  categoryId: number;
}

export interface PostResponse {
  code: number;
  message: string;
  data: any; // Có thể thay đổi tùy theo dữ liệu trả về từ API createPost
}

export interface UploadResponse {
  code: number;
  message: string;
  data: string; // URL của ảnh đã upload
}

export interface AllPostsRequest {
  fromDate: string | null;
  toDate: string | null;
  title: string | null;
  categoryPost: string[];
  page?: number; // Số trang, bắt đầu từ 0
  size?: number; // Số phần tử mỗi trang
  sort?: string | null;
}

export interface Post {
  id: number;
  title: string;
  content: string;
  themeUrl: string | null;
  createdAt: string;
  updatedAt: string | null;
  isActive: boolean;
  isDelete: boolean;
  isOwn: boolean | null;
  category: string; // Tên danh mục (string)
  author: any | null;
}

export interface AllPostsResponse {
  code: number;
  message: string;
  data: {
    content: Post[];
    pageable: {
      pageNumber: number;
      pageSize: number;
      sort: {
        empty: boolean;
        unsorted: boolean;
        sorted: boolean;
      };
      offset: number;
      unpaged: boolean;
      paged: boolean;
    };
    totalPages: number;
    totalElements: number;
    last: boolean;
    size: number;
    number: number;
    sort: {
      empty: boolean;
      unsorted: boolean;
      sorted: boolean;
    };
    numberOfElements: number;
    first: boolean;
    empty: boolean;
  };
}

export interface UpdateStatusRequest {
  id: number;
  isActive?: boolean;
  isDelete?: boolean;
}

export interface UpdateStatusResponse {
  code: number;
  message: string;
  data: any;
}

export interface Category {
  id: number;
  name: string;
}

export interface CategoryResponse {
  code: number;
  message: string;
  data: Category[];
}export interface RegisterRequest {
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  role?: number;
}

export interface LoginRequest {
  email: string;
  password: string;
}

export interface AuthResponse {
  code: number;
  message: string;
  data: {
    token: string;
    authenticated: boolean;
    role: number;
  } | null;
}

export interface LogoutResponse {
  code: number;
  message: string;
  data: null;
}


export interface UpdatePasswordRequest {
  password: string;
  oldPassword: string;
}import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  password: string;
  role: 'student' | 'teacher' | 'manager' | 'consultant' | null;
}

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  token: string | null;
  login: (user: User) => void;
  logout: () => void;
  setToken: (token: string) => void;
}

const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      isAuthenticated: false,
      token: null,
      login: (user) => set({ user, isAuthenticated: true }),
      logout: () => set({ user: null, isAuthenticated: false, token: null }),
      setToken: (token) => set({ token }),
    }),
    { name: 'auth-storage' },
  ),
);

export default useAuthStore;// store/cartStore.ts - FIXED VERSION
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { CartItem } from '../types/cart';

/**
 * ✅ CART STORE INTERFACE - FIXED
 * 
 * Chuyển computed values thành regular state để fix localStorage issue
 */
interface CartState {
  // =================== STATE DATA ===================
  items: CartItem[];               // Danh sách items trong giỏ hàng
  itemCount: number;               // ✅ FIXED: Chuyển thành regular state
  totalAmount: number;             // ✅ FIXED: Chuyển thành regular state  
  isLoading: boolean;              // Đang load từ server
  error: string | null;            // Error message nếu có lỗi
  lastUpdated: string | null;      // Lần cuối sync với server
  
  // =============== ACTIONS (METHODS) ================
  
  // --- Cart Data Operations ---
  setItems: (items: CartItem[]) => void;                       // Set toàn bộ items (từ API)
  addItem: (item: CartItem) => void;                           // Thêm item mới
  removeItem: (cartItemId: number) => void;                    // Xóa item theo cart ID
  clearCart: () => void;                                       // Xóa tất cả items
  
  // --- Helper để update computed values ---
  updateComputedValues: () => void;                            // ✅ NEW: Update count & total
  
  // --- Loading & Error Management ---
  setLoading: (loading: boolean) => void;                      // Set loading state
  setError: (error: string | null) => void;                   // Set error message
  
  // --- Helper Methods ---
  refreshCart: () => Promise<void>;                           // Sync với server
  isItemInCart: (courseId: number) => boolean;                // Check course có trong cart không
  getCartItemByCourseId: (courseId: number) => CartItem | null; // Get cart item theo course ID
  updateLastUpdated: () => void;                              // Update timestamp
}

/**
 * ✅ HELPER: Tính computed values
 */
const calculateComputedValues = (items: CartItem[]) => {
  return {
    itemCount: items.length,
    totalAmount: items.reduce((total, item) => total + item.course.price, 0)
  };
};

/**
 * ✅ ZUSTAND STORE CREATION - FIXED
 */
const useCartStore = create<CartState>()(
  persist(
    (set, get) => ({
      // =================== INITIAL STATE ===================
      items: [],                   // Ban đầu giỏ hàng rỗng
      itemCount: 0,               // ✅ FIXED: Regular state
      totalAmount: 0,             // ✅ FIXED: Regular state
      isLoading: false,           // Không loading
      error: null,                // Không có lỗi
      lastUpdated: null,          // Chưa sync lần nào

      // ================= CART OPERATIONS =================
      
      /**
       * ✅ SET ITEMS - Set toàn bộ cart items (từ API)
       */
      setItems: (items) => {
        const computed = calculateComputedValues(items);
        set({ 
          items, 
          itemCount: computed.itemCount,      // ✅ Update computed values
          totalAmount: computed.totalAmount,  // ✅ Update computed values
          lastUpdated: new Date().toISOString(),
          error: null, 
        });
      },

      /**
       * ✅ ADD ITEM - Thêm item mới vào cart
       */
      addItem: (item) => 
        set((state) => {
          // ✅ Check duplicate
          const existingItem = state.items.find(i => i.course.id === item.course.id);
          if (existingItem) {
            return state; // Không thêm duplicate
          }
          
          const newItems = [...state.items, item];
          const computed = calculateComputedValues(newItems);
          
          return {
            items: newItems,
            itemCount: computed.itemCount,      // ✅ Update computed values
            totalAmount: computed.totalAmount,  // ✅ Update computed values
            lastUpdated: new Date().toISOString(),
            error: null
          };
        }),

      /**
       * ✅ REMOVE ITEM - Xóa item theo cart item ID
       */
      removeItem: (cartItemId) => 
        set((state) => {
          const newItems = state.items.filter(item => item.id !== cartItemId);
          const computed = calculateComputedValues(newItems);
          
          return {
            items: newItems,
            itemCount: computed.itemCount,      // ✅ Update computed values
            totalAmount: computed.totalAmount,  // ✅ Update computed values
            lastUpdated: new Date().toISOString(),
            error: null
          };
        }),

      /**
       * ✅ CLEAR CART - Xóa tất cả items
       */
      clearCart: () => 
        set({ 
          items: [],
          itemCount: 0,               // ✅ Reset computed values
          totalAmount: 0,             // ✅ Reset computed values
          lastUpdated: new Date().toISOString(),
          error: null 
        }),

      /**
       * ✅ UPDATE COMPUTED VALUES - Manual update nếu cần
       */
      updateComputedValues: () => 
        set((state) => {
          const computed = calculateComputedValues(state.items);
          return {
            itemCount: computed.itemCount,
            totalAmount: computed.totalAmount
          };
        }),

      // ============== LOADING & ERROR MANAGEMENT ==============
      
      setLoading: (loading) => set({ isLoading: loading }),
      
      setError: (error) => set({ error }),

      // ================== HELPER METHODS ==================
      
      /**
       * ✅ REFRESH CART - Sync với server
       */
      refreshCart: async () => {
        set({ isLoading: true, error: null });
        
        try {
          // ✅ Dynamic import để tránh circular dependency
          const { getCartService } = await import('../services/cartService');
          const response = await getCartService();
          
          // ✅ Sử dụng setItems để tự động update computed values
          const computed = calculateComputedValues(response.data);
          
          set({ 
            items: response.data,
            itemCount: computed.itemCount,      // ✅ Ensure computed values updated
            totalAmount: computed.totalAmount,  // ✅ Ensure computed values updated
            isLoading: false,
            lastUpdated: new Date().toISOString(),
            error: null
          });
          
        } catch (error: any) {
          set({ 
            isLoading: false, 
            error: error.message || 'Lỗi khi tải giỏ hàng' 
          });
        }
      },

      /**
       * ✅ IS ITEM IN CART - Kiểm tra course có trong cart không
       */
      isItemInCart: (courseId) => {
        return get().items.some(item => item.course.id === courseId);
      },

      /**
       * ✅ GET CART ITEM BY COURSE ID
       */
      getCartItemByCourseId: (courseId) => {
        return get().items.find(item => item.course.id === courseId) || null;
      },

      /**
       * ✅ UPDATE TIMESTAMP
       */
      updateLastUpdated: () => 
        set({ lastUpdated: new Date().toISOString() })
    }),
    
    // ================ PERSIST CONFIGURATION ================
    { 
      name: 'cart-storage',  // localStorage key
      partialize: (state) => ({
        items: state.items,
        itemCount: state.itemCount,         // ✅ PERSIST computed values
        totalAmount: state.totalAmount,     // ✅ PERSIST computed values
        lastUpdated: state.lastUpdated
        // KHÔNG persist: isLoading, error (temporary states)
      }),
      
      // ✅ HYDRATION CALLBACK - Đảm bảo computed values đúng sau khi restore
      onRehydrateStorage: () => (state) => {
        if (state) {
          // ✅ Recalculate computed values sau khi restore từ localStorage
          const computed = calculateComputedValues(state.items);
          state.itemCount = computed.itemCount;
          state.totalAmount = computed.totalAmount;
        }
      }
    }
  )
);

export default useCartStore;// store/orderStore.ts - Updated with txnRef methods
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { Order, OrderStatus } from '../types/order';

/**
 * ✅ ORDER STORE INTERFACE
 * Định nghĩa tất cả state và actions cho Order Management
 */
interface OrderState {
  // =================== STATE DATA ===================
  orders: Order[];                 // Danh sách đơn hàng
  isLoading: boolean;              // Đang load orders từ server
  error: string | null;            // Error message nếu có lỗi
  lastUpdated: string | null;      // Lần cuối cập nhật (cho sync)
  
  // Current order being processed (cho purchase flow)
  currentOrder: Order | null;      // Đơn hàng đang được xử lý
  
  // ============== COMPUTED VALUES (GETTERS) ==============
  pendingOrdersCount: number;      // Số đơn hàng đang chờ
  completedOrdersCount: number;    // Số đơn hàng hoàn thành
  totalSpent: number;              // Tổng tiền đã chi tiêu
  
  // =============== ACTIONS (METHODS) ================
  
  // --- Order Data Operations ---
  setOrders: (orders: Order[]) => void;                    // Set toàn bộ orders (từ API)
  addOrder: (order: Order) => void;                        // Thêm order mới (sau khi tạo)
  updateOrder: (orderId: number, updatedOrder: Partial<Order>) => void; // Update order
  removeOrder: (orderId: number) => void;                  // Xóa order (sau khi delete API)
  setCurrentOrder: (order: Order | null) => void;          // Set order đang xử lý
  
  // --- Loading & Error Management ---
  setLoading: (loading: boolean) => void;                  // Set loading state
  setError: (error: string | null) => void;               // Set error message
  
  // --- Helper Methods ---
  refreshOrders: () => Promise<void>;                     // Sync với server
  getOrderById: (orderId: number) => Order | null;        // Lấy order theo ID
  getOrdersByStatus: (status: OrderStatus) => Order[];    // Lấy orders theo status
  getOrderByTxnRef: (txnRef: string) => Order | null;     // ✅ NEW: Lấy order theo txnRef
  updateOrderByTxnRef: (txnRef: string, updates: Partial<Order>) => void; // ✅ NEW: Update bằng txnRef
  updateLastUpdated: () => void;                          // Update timestamp
}

/**
 * ✅ ZUSTAND STORE CREATION
 */
const useOrderStore = create<OrderState>()(
  persist(
    (set, get) => ({
      // =================== INITIAL STATE ===================
      orders: [],              // Ban đầu chưa có orders
      isLoading: false,        // Không loading
      error: null,             // Không có lỗi
      lastUpdated: null,       // Chưa update lần nào
      currentOrder: null,      // Không có order đang xử lý
      
      // =============== COMPUTED VALUES =================
      get pendingOrdersCount() {
        return get().orders.filter(order => order.status === 'PENDING').length;
      },

      get completedOrdersCount() {
        return get().orders.filter(order => order.status === 'COMPLETED').length;
      },

      get totalSpent() {
        return get().orders
          .filter(order => order.status === 'COMPLETED')
          .reduce((total, order) => {
            // Dùng totalAmount nếu có, nếu không dùng priceAtPurchase
            return total + (order.totalAmount || order.detail.priceAtPurchase);
          }, 0);
      },

      // ================= ORDER OPERATIONS =================
      
      /**
       * Set toàn bộ orders (thường từ API response)
       * Sort theo ngày tạo mới nhất
       */
      setOrders: (orders) => 
        set({ 
          orders: orders.sort((a, b) => 
            new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
          ),
          lastUpdated: new Date().toISOString(),
          error: null 
        }),

      /**
       * Thêm order mới (sau khi tạo đơn hàng thành công)
       * Thêm vào đầu array để hiển thị đầu tiên
       */
      addOrder: (order) => 
        set((state) => ({
          orders: [order, ...state.orders],
          lastUpdated: new Date().toISOString(),
          error: null
        })),

      /**
       * Update thông tin order (ví dụ: status change, payment update)
       */
      updateOrder: (orderId, updatedOrder) => 
        set((state) => ({
          orders: state.orders.map(order =>
            order.id === orderId ? { ...order, ...updatedOrder } : order
          ),
          lastUpdated: new Date().toISOString(),
          error: null
        })),

      /**
       * Xóa order (sau khi delete API thành công)
       */
      removeOrder: (orderId) => 
        set((state) => ({
          orders: state.orders.filter(order => order.id !== orderId),
          lastUpdated: new Date().toISOString(),
          error: null
        })),

      /**
       * Set current order đang được xử lý (cho purchase flow)
       */
      setCurrentOrder: (order) => set({ currentOrder: order }),

      // ============== LOADING & ERROR MANAGEMENT ==============
      
      setLoading: (loading) => set({ isLoading: loading }),
      
      setError: (error) => set({ error }),

      // ================== HELPER METHODS ==================
      
      /**
       * ✅ REFRESH ORDERS - Sync với server
       * 
       * Gọi API để lấy orders mới nhất từ server
       */
      refreshOrders: async () => {
        set({ isLoading: true, error: null });
        
        try {
          // ✅ Dynamic import để tránh circular dependency
          const { getOrdersService } = await import('../services/orderService');
          const response = await getOrdersService();
          
          // Sort orders theo createdAt mới nhất
          const sortedOrders = response.data.sort((a, b) => 
            new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
          );
          
          set({ 
            orders: sortedOrders,
            isLoading: false,
            lastUpdated: new Date().toISOString(),
            error: null
          });
          
        } catch (error: any) {
          set({ 
            isLoading: false, 
            error: error.message || 'Lỗi khi tải danh sách đơn hàng' 
          });
        }
      },

      /**
       * ✅ GET ORDER BY ID
       */
      getOrderById: (orderId) => {
        return get().orders.find(order => order.id === orderId) || null;
      },

      /**
       * ✅ GET ORDERS BY STATUS
       */
      getOrdersByStatus: (status) => {
        return get().orders.filter(order => order.status === status);
      },

      /**
       * ✅ GET ORDER BY TRANSACTION REF
       * Tìm order theo txnRef từ VNPay callback
       * 
       * @param txnRef - Format: "20250821160529_7" where 7 is orderId
       * @returns Order | null
       */
      getOrderByTxnRef: (txnRef) => {
        // ✅ Parse orderId from txnRef
        // txnRef format: "20250821160529_7" -> orderId = 7
        const parts = txnRef.split('_');
        if (parts.length < 2) {
          console.warn(`Invalid txnRef format: ${txnRef}`);
          return null;
        }
        
        const orderIdStr = parts[parts.length - 1]; // Lấy phần cuối
        const orderId = parseInt(orderIdStr);
        
        if (isNaN(orderId)) {
          console.warn(`Cannot parse orderId from txnRef: ${txnRef}`);
          return null;
        }
        
        return get().orders.find(order => order.id === orderId) || null;
      },

      /**
       * ✅ UPDATE ORDER STATUS BY TXNREF
       * Cập nhật order status sau khi thanh toán
       * 
       * @param txnRef - Transaction reference từ VNPay
       * @param updates - Partial order data để update
       */
      updateOrderByTxnRef: (txnRef, updates) => {
        // ✅ Parse orderId từ txnRef
        const parts = txnRef.split('_');
        if (parts.length < 2) {
          console.warn(`Invalid txnRef format: ${txnRef}`);
          return;
        }
        
        const orderIdStr = parts[parts.length - 1];
        const orderId = parseInt(orderIdStr);
        
        if (isNaN(orderId)) {
          console.warn(`Cannot parse orderId from txnRef: ${txnRef}`);
          return;
        }
        
        // ✅ Update order với orderId tương ứng
        set((state) => ({
          orders: state.orders.map(order =>
            order.id === orderId ? { 
              ...order, 
              ...updates,
              updatedAt: new Date().toISOString() // ✅ Always update timestamp
            } : order
          ),
          lastUpdated: new Date().toISOString(),
          error: null
        }));
        
        console.log(`Updated order ${orderId} from txnRef ${txnRef}:`, updates);
      },

      /**
       * Update timestamp
       */
      updateLastUpdated: () => 
        set({ lastUpdated: new Date().toISOString() })
    }),
    
    // ================ PERSIST CONFIGURATION ================
    { 
      name: 'order-storage',  // localStorage key
      partialize: (state) => ({
        orders: state.orders,
        lastUpdated: state.lastUpdated
        // KHÔNG lưu: isLoading, error, currentOrder (temporary states)
      })
    }
  )
);

export default useOrderStore;import { message } from 'antd';
import { login, register, logout, refreshToken, updatePassword } from '../api/authApi';
import useAuthStore from '../store/authStore';
import type { RegisterRequest, LoginRequest, AuthResponse, LogoutResponse, UpdatePasswordRequest } from '../types/auth';
import type { UserProfileResponse } from 'types/user';
import { getUserProfile } from '../api/userApi';

const roleMapping: { [key: number]: 'student' | 'teacher' | 'manager' | 'consultant' } = {
  1: 'manager',
  2: 'consultant',
  3: 'teacher',
  4: 'student',
};

export const registerService = async (data: RegisterRequest): Promise<LogoutResponse> => {
  try {
    const response = await register(data);
    if (response.code === 200) {
      message.success('Đăng ký thành công! Vui lòng đăng nhập.');
      return response;
    }
    throw new Error(response.message || 'Đăng ký thất bại.');
  } catch (error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi đăng ký.');
    throw error;
  }
};

export const loginService = async (data: LoginRequest): Promise<AuthResponse> => {
  try {
    const response = await login(data);
    if (response.code === 200 && response.data) {
      const { token, role } = response.data;
      useAuthStore.getState().setToken(token);
      const userProfile = await getUserProfile();
      const userRole = roleMapping[role] || 'student';
      useAuthStore.getState().login({
        id: userProfile.data.id || '',
        firstName: userProfile.data.firstName || '',
        lastName: userProfile.data.lastName || '',
        email: data.email,
        password: data.password,
        role: userRole,
      });
      message.success('Đăng nhập thành công!');
      return response;
    }
    throw new Error(response.message || 'Đăng nhập thất bại.');
  } catch (error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi đăng nhập.');
    throw error;
  }
};

export const logoutService = async (): Promise<LogoutResponse> => {
  try {
    const response = await logout();
    if (response.code === 200) {
      useAuthStore.getState().logout();
      message.success('Đăng xuất thành công!');
      return response;
    }
    throw new Error(response.message || 'Đăng xuất thất bại.');
  } catch (error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi đăng xuất.');
    throw error;
  }
};

export const refreshTokenService = async (): Promise<AuthResponse> => {
  try {
    const response = await refreshToken();
    if (response.code === 200 && response.data) {
      const { token } = response.data;
      useAuthStore.getState().setToken(token);
      return response;
    }
    throw new Error(response.message || 'Không thể làm mới token.');
  } catch (error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi làm mới token.');
    throw error;
  }
};

export const updatePasswordService = async(data: UpdatePasswordRequest) : Promise<UserProfileResponse> => {
  try{
    const response = await updatePassword(data);
    if(response.code === 200 && response.data){
      message.success('Đổi mật khẩu thành công');
      return response;
    }
    throw new Error(response.message || 'Đổi mật khẩu thất bại.');
  }catch(error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi đổi mật khẩu.');
    throw error;
  }
}// services/courseManagementService.ts - Cải thiện
import { message } from 'antd';
import { 
  getAllCourses, 
  getCourseById, 
  createCourse, 
  updateCourseInfo, 
  updateCourseStatus, 
  uploadImage, 
  getCategories 
} from '../api/courseApi';
import type { 
  AllCoursesRequest, 
  CourseResponse, 
  CourseDetailResponse, 
  CourseCreateRequest, 
  CourseUpdateRequest, 
  CourseStatusUpdateRequest, // ✅ Thêm type mới
  UploadResponse, 
  CategoryResponse 
} from '../types/course';

export const getAllCoursesService = async (data: AllCoursesRequest): Promise<CourseResponse> => {
  try {
    const response = await getAllCourses(data);
    if (response.code === 200) {
      return response;
    }
    throw new Error(response.message || 'Lấy danh sách khóa học thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy danh sách khóa học.');
    throw error;
  }
};

// ✅ Thêm service để lấy danh sách giáo viên
export const getTeachersService = async () => {
  try {
    // Sử dụng API filter user để lấy danh sách giáo viên
    const { filterUsersService } = await import('./userService');
    const response = await filterUsersService({
      userRoles: ['TEACHER'],
      isActive: true,
      isDelete: false,
      page: 0,
      size: 100,
    });
    
    if (response.code === 200) {
      return response.data.content;
    }
    return [];
  } catch (error: any) {
    console.error('Lỗi khi lấy danh sách giáo viên:', error);
    return [];
  }
};

export const getCourseByIdService = async (id: number): Promise<CourseDetailResponse> => {
  try {
    const response = await getCourseById(id);
    if (response.code === 200) {
      return response;
    }
    throw new Error(response.message || 'Lấy chi tiết khóa học thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy chi tiết khóa học.');
    throw error;
  }
};

export const createCourseService = async (data: CourseCreateRequest): Promise<CourseDetailResponse> => {
  try {
    const response = await createCourse(data);
    if (response.code === 200) {
      message.success('Tạo khóa học thành công!');
      return response;
    }
    throw new Error(response.message || 'Tạo khóa học thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi tạo khóa học.');
    throw error;
  }
};

export const updateCourseInfoService = async (data: CourseUpdateRequest): Promise<CourseDetailResponse> => {
  try {
    const response = await updateCourseInfo(data);
    if (response.code === 200) {
      message.success('Cập nhật khóa học thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật khóa học thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật khóa học.');
    throw error;
  }
};

// ✅ Tách riêng service cho update status
export const updateCourseStatusService = async (data: CourseStatusUpdateRequest): Promise<CourseDetailResponse> => {
  try {
    const response = await updateCourseStatus(data);
    if (response.code === 200) {
      message.success('Cập nhật trạng thái khóa học thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật trạng thái khóa học thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật trạng thái khóa học.');
    throw error;
  }
};

export const uploadImageService = async (formData: FormData): Promise<UploadResponse> => {
  try {
    const response = await uploadImage(formData);
    if (response.code === 200) {
      message.success('Tải ảnh thành công!');
      return response;
    }
    throw new Error(response.message || 'Tải ảnh thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi tải ảnh.');
    throw error;
  }
};

export const getCategoriesService = async (): Promise<CategoryResponse> => {
  try {
    const response = await getCategories();
    if (response.code === 200) {
      return response;
    }
    throw new Error(response.message || 'Lấy danh sách danh mục thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy danh sách danh mục.');
    throw error;
  }
};import { message } from 'antd';
import { createPost, uploadImage, getAllPosts, updatePostStatus, getCategories } from '../api/blogApi';
import type { PostData, PostResponse, UploadResponse, AllPostsRequest, AllPostsResponse, UpdateStatusRequest, UpdateStatusResponse, CategoryResponse } from '../types/blog';

export const createPostService = async (data: PostData): Promise<PostResponse> => {
  try {
    const response = await createPost(data);
    if (response.code === 200) {
      message.success('Đăng bài thành công!');
      return response;
    }
    throw new Error(response.message || 'Đăng bài thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi đăng bài.');
    throw error;
  }
};

export const uploadImageService = async (formData: FormData): Promise<UploadResponse> => {
  try {
    const response = await uploadImage(formData);
    if (response.code === 200) {
      message.success('Tải ảnh thành công!');
      return response;
    }
    throw new Error(response.message || 'Tải ảnh thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi tải ảnh.');
    throw error;
  }
};

export const getAllPostsService = async (data: AllPostsRequest): Promise<AllPostsResponse> => {
  try {
    const response = await getAllPosts(data);
    // console.log('data',data);
    
    if (response.code === 200) {
      message.success('Lấy danh sách bài đăng thành công!');
      return response;
    }
    throw new Error(response.message || 'Lấy danh sách bài đăng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy danh sách bài đăng.');
    throw error;
  }
};

export const updatePostStatusService = async (data: UpdateStatusRequest): Promise<UpdateStatusResponse> => {
  try {
    const response = await updatePostStatus(data);
    if (response.code === 200) {
      message.success('Cập nhật trạng thái bài đăng thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật trạng thái bài đăng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật trạng thái bài đăng.');
    throw error;
  }
};

export const getCategoriesService = async (): Promise<CategoryResponse> => {
  try {
    const response = await getCategories();
    if (response.code === 200) {
      return response;
    }
    throw new Error(response.message || 'Lấy danh sách danh mục thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy danh sách danh mục.');
    throw error;
  }
};// services/orderService.ts
import { message } from 'antd';
import { 
  createOrderByCourse, 
  createOrderByCartItem, 
  getOrders, 
  deleteOrder
} from '../api/orderApi';
import type { 
  OrderResponse, 
  CreateOrderResponse 
} from '../types/order';

/**
 * ✅ SERVICE: TẠO ĐƠN HÀNG TRỰC TIẾP TỪ KHÓA HỌC
 * 
 * Xử lý logic:
 * - Validate course có thể mua không
 * - Call API create order
 * - Show success message với order info
 * - Handle errors appropriately
 */
export const createOrderByCourseService = async (courseId: number): Promise<CreateOrderResponse> => {
  try {
    const response = await createOrderByCourse(courseId);
    
    if (response.code === 200) {
      message.success('Đã tạo đơn hàng thành công! Vui lòng tiến hành thanh toán.');
      return response;
    }
    
    throw new Error(response.message || 'Tạo đơn hàng thất bại.');
    
  } catch (error: any) {
    const errorMessage = error.response?.data?.message 
      || error.message 
      || 'Lỗi khi tạo đơn hàng.';
    
    message.error(errorMessage);
    throw error;
  }
};

/**
 * ✅ SERVICE: TẠO ĐƠN HÀNG TỪ CART ITEM
 * 
 * @param cartItemId - ID của cart item
 */
export const createOrderByCartItemService = async (cartItemId: number): Promise<CreateOrderResponse> => {
  try {
    const response = await createOrderByCartItem(cartItemId);
    
    if (response.code === 200) {
      message.success('Đã tạo đơn hàng từ giỏ hàng thành công! Vui lòng tiến hành thanh toán.');
      return response;
    }
    
    throw new Error(response.message || 'Tạo đơn hàng từ giỏ hàng thất bại.');
    
  } catch (error: any) {
    const errorMessage = error.response?.data?.message 
      || error.message 
      || 'Lỗi khi tạo đơn hàng từ giỏ hàng.';
    
    message.error(errorMessage);
    throw error;
  }
};

/**
 * ✅ SERVICE: LẤY DANH SÁCH ĐƠN HÀNG
 * 
 * Xử lý logic:
 * - Call API để lấy orders
 * - Không show message (silent operation)
 * - Handle empty list gracefully
 */
export const getOrdersService = async (): Promise<OrderResponse> => {
  try {
    const response = await getOrders();
    
    if (response.code === 200) {
      return response;
    }
    
    throw new Error(response.message || 'Lấy danh sách đơn hàng thất bại.');
    
  } catch (error: any) {
    const errorMessage = error.response?.data?.message 
      || error.message 
      || 'Lỗi khi lấy danh sách đơn hàng.';
    
    message.error(errorMessage);
    throw error;
  }
};

/**
 * ✅ SERVICE: XÓA/HỦY ĐƠN HÀNG
 * 
 * @param orderId - ID của đơn hàng cần xóa
 */
export const deleteOrderService = async (orderId: number): Promise<void> => {
  try {
    const response = await deleteOrder(orderId);
    
    if (response.code === 200) {
      message.success('Đã hủy đơn hàng thành công!');
      return;
    }
    
    throw new Error(response.message || 'Hủy đơn hàng thất bại.');
    
  } catch (error: any) {
    const errorMessage = error.response?.data?.message 
      || error.message 
      || 'Lỗi khi hủy đơn hàng.';
    
    message.error(errorMessage);
    throw error;
  }
};

/**
 * ✅ HELPER SERVICE: Mua trực tiếp với loading message
 */
export const purchaseDirectlyService = async (courseId: number): Promise<CreateOrderResponse> => {
  try {
    message.loading({ content: 'Đang tạo đơn hàng...', key: 'purchase' });
    const response = await createOrderByCourseService(courseId);
    message.destroy('purchase');
    return response;
  } catch (error: any) {
    message.destroy('purchase');
    throw error;
  }
};

/**
 * ✅ HELPER SERVICE: Mua từ giỏ hàng với loading message
 */
export const purchaseFromCartService = async (cartItemId: number): Promise<CreateOrderResponse> => {
  try {
    message.loading({ content: 'Đang tạo đơn hàng...', key: 'purchase-cart' });
    const response = await createOrderByCartItemService(cartItemId);
    message.destroy('purchase-cart');
    return response;
  } catch (error: any) {
    message.destroy('purchase-cart');
    throw error;
  }
};import type { PaymentResponse } from 'types/payment';
// services/paymentService.ts
import { message } from 'antd';
import { createPayment } from '../api/paymentApi';

/**
 * ✅ SERVICE: TẠO PAYMENT URL VÀ MỞ TRONG TAB MỚI
 * 
 * @param orderId - ID của đơn hàng cần thanh toán
 * @returns Promise<PaymentResponse>
 */
export const createPaymentService = async (orderId: number): Promise<PaymentResponse> => {
  try {
    message.loading({ content: 'Đang tạo liên kết thanh toán...', key: 'payment' });
    
    const response = await createPayment(orderId);
    
    if (response.code === 200 && response.data.url) {
      message.destroy('payment');
      message.success('Đã tạo liên kết thanh toán! Chuyển hướng...');
      
      // ✅ Mở VNPay URL trong tab mới
      const paymentWindow = window.open(
        response.data.url, 
        '_blank',
        'width=800,height=600,scrollbars=yes,resizable=yes'
      );
      
      // ✅ Optional: Focus vào payment window
      if (paymentWindow) {
        paymentWindow.focus();
      }
      
      return response;
    }
    
    throw new Error(response.message || 'Tạo liên kết thanh toán thất bại.');
    
  } catch (error: any) {
    message.destroy('payment');
    const errorMessage = error.response?.data?.message 
      || error.message 
      || 'Lỗi khi tạo liên kết thanh toán.';
    
    message.error(errorMessage);
    throw error;
  }
};

/*
 * ✅ HELPER: PARSE PAYMENT CALLBACK URL PARAMS
 * 
 * Lấy params từ URL callback: /order-status?status=success&txnRef=xxx...
 */
export const parsePaymentCallback = (search: string) => {
  const params = new URLSearchParams(search);
  
  return {
    status: params.get('status'),
    txnRef: params.get('txnRef'),
    transactionNo: params.get('transactionNo'),
    amount: params.get('amount'),
    payDate: params.get('payDate'),
  };
};

/**
 * ✅ HELPER: FORMAT PAYMENT AMOUNT
 */
export const formatPaymentAmount = (amount: string | null): number => {
  if (!amount) return 0;
  // VNPay trả về amount * 100, cần chia lại
  return parseInt(amount) / 100;
};

/**
 * ✅ SERVICE: CẬP NHẬT ORDER STATUS SAU KHI THANH TOÁN
 * 
 * @param txnRef - Transaction reference từ VNPay
 * @param paymentData - Thông tin thanh toán từ callback
 */
export const updateOrderAfterPayment = async (txnRef: string, paymentData: any) => {
  try {
    // ✅ Import order store
    const { default: useOrderStore } = await import('../store/orderStore');
    const { updateOrderByTxnRef, refreshOrders } = useOrderStore.getState();
    
    // ✅ Determine order status based on payment status
    const orderStatus = paymentData.status === 'success' ? 'COMPLETED' : 'FAILED';
    
    // ✅ Update order với thông tin thanh toán
    const orderUpdates = {
      status: orderStatus,
      transactionCode: paymentData.transactionNo || null,
      totalAmount: paymentData.formattedAmount || null,
      updatedAt: new Date().toISOString(),
    };
    
    // ✅ Update local store trước
    updateOrderByTxnRef(txnRef, orderUpdates);
    
    // ✅ Refresh từ server để đảm bảo data sync
    setTimeout(() => {
      refreshOrders();
    }, 1000);
    
    return true;
    
  } catch (error) {
    console.error('Update order after payment failed:', error);
    return false;
  }
};import { message } from 'antd';
import { filterUsers, disableUser, deleteUser, updateUserInfo, getUserProfile } from '../api/userApi';
import type { FilterRequest, FilterResponse, DisableUserRequest, DisableUserResponse, DeleteUserRequest, DeleteUserResponse, UpdateUserInfoRequest, UpdateUserInfoResponse, UserProfileResponse } from '../types/user';

export const filterUsersService = async (data: FilterRequest): Promise<FilterResponse> => {
  try {
    const response = await filterUsers(data);
    if (response.code === 200) {
      // message.success('Lấy danh sách người dùng thành công!');
      return response;
    }
    throw new Error(response.message || 'Lấy danh sách người dùng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi lấy danh sách người dùng.');
    throw error;
  }
};

export const disableUserService = async (data: DisableUserRequest): Promise<DisableUserResponse> => {
  try {
    const response = await disableUser(data);
    if (response.code === 200) {
      message.success('Cập nhật trạng thái người dùng thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật trạng thái người dùng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật trạng thái người dùng.');
    throw error;
  }
};

export const deleteUserService = async (data: DeleteUserRequest): Promise<DeleteUserResponse> => {
  try {
    const response = await deleteUser(data);
    if (response.code === 200) {
      message.success('Cập nhật trạng thái xóa người dùng thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật trạng thái xóa người dùng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật trạng thái xóa người dùng.');
    throw error;
  }
};
export const getUserProfileService = async (): Promise<UserProfileResponse> => {
  try {
    const response = await getUserProfile();
    if (response.code === 200 && response.data) {
      message.success('Lấy thông tin cá nhân thành công');
      return response;
    }
    throw new Error(response.message || 'Lấy thông tin cá nhân thất bại.');
  } catch (error: any) {
    message.error(error.message || 'Đã có lỗi xảy ra khi lấy thông tin cá nhân.');
    throw error;
  }
};

export const updateUserInfoService = async (data: UpdateUserInfoRequest): Promise<UpdateUserInfoResponse> => {
  try {
    const response = await updateUserInfo(data);
    if (response.code === 200) {
      message.success('Cập nhật thông tin người dùng thành công!');
      return response;
    }
    throw new Error(response.message || 'Cập nhật thông tin người dùng thất bại.');
  } catch (error: any) {
    message.error(error.response?.data?.message || 'Lỗi khi cập nhật thông tin người dùng.');
    throw error;
  }
};// routes/index.ts - Updated with Cart & Orders & Payment Callback
import React from 'react';
import { createBrowserRouter } from 'react-router-dom';
import Home from '../pages/public-page/Home/Home';
import MainLayout from '../layouts/MainLayout/MainLayout';
import Courses from '../pages/public-page/Courses/Course';
import Blog from '../pages/public-page/Blog/Blog';
import Test from '../pages/public-page/Test/Test';
import VideoCourses from '../pages/student/VideoCourses/VideoCourses';
import OfflineClasses from '../pages/teacher/OfflineClasses/OfflineClasses';
import ClassManagement from '../pages/manage/ClassManagement/ClassManagement';
import Dashboard from '../pages/common/Dashboard/Dashboard';
import Profile from '../pages/common/Profile/Profile';
import QuestionBank from '../pages/manage/QuestionBank/QuestionBank';
import Statistics from '../pages/manage/Statistics/Statistics';
import MemberManagement from '../pages/manage/MemberManagement/MemberManagement';
import CourseManagement from '../pages/manage/CourseManagement/CourseManagement';
import BlogApproval from '../pages/manage/BlogApproval/BlogApproval';
import Business from '../pages/manage/Business/Business';
import WriteBlog from '../pages/manage/WriteBlog/WriteBlog';
import Cart from '../pages/student/Cart/Cart';              // ✅ Phase 1
import Orders from '../pages/student/Orders/Orders';        // ✅ Phase 2 - NEW
import OrderStatus from '../pages/student/OrderStatus/OrderStatus'; // ✅ Phase 3 - Payment Callback
import ProtectedRoute from '../components/common/ProtectedRoute/ProtectedRoute';

const router = createBrowserRouter([
  {
    path: '/',
    element: React.createElement(MainLayout),
    children: [
      // ✅ PUBLIC ROUTES
      { path: '/', element: React.createElement(Home) },
      { path: '/courses', element: React.createElement(Courses) },
      { path: '/blog', element: React.createElement(Blog) },
      { path: '/test', element: React.createElement(Test) },
      
      // ✅ PAYMENT CALLBACK ROUTE - Public nhưng cần auth
      { path: '/order-status', element: React.createElement(OrderStatus) },
      
      // ✅ DASHBOARD ROUTES
      {
        path: '/dashboard',
        element: React.createElement(Dashboard),
        children: [
          // Profile (tất cả roles)
          {
            path: 'profile',
            element: React.createElement(ProtectedRoute, { allowedTab: 'profile' }),
            children: [{ path: '', element: React.createElement(Profile) }],
          },
          
          // ===== STUDENT ROUTES =====
          {
            path: 'video-courses',
            element: React.createElement(ProtectedRoute, { allowedTab: 'video-courses' }),
            children: [{ path: '', element: React.createElement(VideoCourses) }],
          },
          {
            path: 'offline-classes',
            element: React.createElement(ProtectedRoute, { allowedTab: 'offline-classes' }),
            children: [{ path: '', element: React.createElement(OfflineClasses) }],
          },
          // ✅ PHASE 1: Cart page for students
          {
            path: 'cart',
            element: React.createElement(ProtectedRoute, { allowedTab: 'cart' }),
            children: [{ path: '', element: React.createElement(Cart) }],
          },
          // ✅ PHASE 2: Orders page for students - NEW
          {
            path: 'orders',
            element: React.createElement(ProtectedRoute, { allowedTab: 'orders' }),
            children: [{ path: '', element: React.createElement(Orders) }],
          },
          
          // ===== TEACHER ROUTES =====
          {
            path: 'class-management',
            element: React.createElement(ProtectedRoute, { allowedTab: 'class-management' }),
            children: [{ path: '', element: React.createElement(ClassManagement) }],
          },
          {
            path: 'question-bank',
            element: React.createElement(ProtectedRoute, { allowedTab: 'question-bank' }),
            children: [{ path: '', element: React.createElement(QuestionBank) }],
          },
          
          // ===== MANAGER ROUTES =====
          {
            path: 'statistics',
            element: React.createElement(ProtectedRoute, { allowedTab: 'statistics' }),
            children: [{ path: '', element: React.createElement(Statistics) }],
          },
          {
            path: 'member-management',
            element: React.createElement(ProtectedRoute, { allowedTab: 'member-management' }),
            children: [{ path: '', element: React.createElement(MemberManagement) }],
          },
          {
            path: 'course-management',
            element: React.createElement(ProtectedRoute, { allowedTab: 'course-management' }),
            children: [{ path: '', element: React.createElement(CourseManagement) }],
          },
          {
            path: 'blog-approval',
            element: React.createElement(ProtectedRoute, { allowedTab: 'blog-approval' }),
            children: [{ path: '', element: React.createElement(BlogApproval) }],
          },
          {
            path: 'business',
            element: React.createElement(ProtectedRoute, { allowedTab: 'business' }),
            children: [{ path: '', element: React.createElement(Business) }],
          },
          
          // ===== CONSULTANT ROUTES =====
          {
            path: 'write-blog',
            element: React.createElement(ProtectedRoute, { allowedTab: 'write-blog' }),
            children: [{ path: '', element: React.createElement(WriteBlog) }],
          },
        ],
      },
    ],
  },
]);

export default router;
// pages/Cart/Cart.tsx
import React, { useEffect } from 'react';
import { Card, Button, Typography, Empty, List, Image, Modal, Divider } from 'antd';
import { DeleteOutlined, CreditCardOutlined, ClearOutlined, ShoppingOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import useCartStore from '../../../store/cartStore';
import { removeFromCartService, clearCartService } from '../../../services/cartService';
import type { CartItem } from '../../../types/cart';
import './Cart.css';

const { Title, Text } = Typography;

/**
 * ✅ CART PAGE COMPONENT
 * 
 * Trang giỏ hàng đầy đủ với tất cả chức năng:
 * - Hiển thị danh sách items
 * - Xóa items / Clear cart
 * - Mua từng item hoặc mua tất cả
 * - Navigate đến courses page
 */

const CartPage: React.FC = () => {
  const navigate = useNavigate();
  
  // ✅ CART STATE
  const { 
    items, 
    itemCount, 
    totalAmount, 
    isLoading,
    removeItem,
    clearCart,
    refreshCart
  } = useCartStore();

  // ✅ LOAD CART khi component mount
  useEffect(() => {
    refreshCart();
  }, [refreshCart]);

  // ✅ FORMAT PRICE HELPER
  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  // const formatRelativeTime = (dateString: string | null) => {
  //   if (!dateString) return 'Không xác định';
    
  //   const now = new Date();
  //   const date = new Date(dateString);
  //   const diffMs = now.getTime() - date.getTime();
  //   const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  //   const diffDays = Math.floor(diffHours / 24);
    
  //   if (diffDays > 0) return `${diffDays} ngày trước`;
  //   if (diffHours > 0) return `${diffHours} giờ trước`;
  //   return 'Vừa xong';
  // };

  // ✅ EVENT HANDLERS
  const handleRemoveItem = async (cartItemId: number, courseName: string) => {
    Modal.confirm({
      title: 'Xác nhận xóa khóa học',
      content: `Bạn có chắc muốn xóa "${courseName}" khỏi giỏ hàng?`,
      okText: 'Xóa',
      cancelText: 'Hủy',
      okType: 'danger',
      onOk: async () => {
        try {
          await removeFromCartService(cartItemId);
          
          // Optimistic update
          removeItem(cartItemId);
          
          // Refresh để sync với server
          setTimeout(() => refreshCart(), 500);
          
        } catch (error) {
          console.error('Remove from cart failed:', error);
        }
      }
    });
  };

  const handleBuyFromCart = async (cartItemId: number, courseName: string) => {
    try {
      // ✅ Import orderService và orderStore
      const { purchaseFromCartService } = await import('../../../services/orderService');
      // const addOrder  = await import('../../store/orderStore');
      
      // ✅ Tạo đơn hàng từ cart item
      const orderResponse = await purchaseFromCartService(cartItemId);
      
      if (orderResponse.code === 200) {
        // ✅ Cập nhật order store
        const { default: useOrderStore } = await import('../../../store/orderStore');
        useOrderStore.getState().addOrder(orderResponse.data);
        
        // ✅ Xóa item khỏi cart sau khi tạo order thành công
        removeItem(cartItemId);
        
        // ✅ Show success và navigate đến orders page
        Modal.success({
          title: 'Tạo đơn hàng thành công!',
          content: `Đơn hàng cho "${courseName}" đã được tạo. Chuyển đến trang đơn hàng để thanh toán.`,
          onOk: () => {
            navigate('/dashboard/orders');
          }
        });
        
        // ✅ Auto navigate sau 2s nếu user không click OK
        setTimeout(() => {
          navigate('/dashboard/orders');
        }, 2000);
      }
      
    } catch (error) {
      console.error('Purchase from cart failed:', error);
      // Error message đã được handle trong service
    }
  };
  
  const handleClearCart = () => {
    if (itemCount === 0) return;
    
    Modal.confirm({
      title: 'Xóa tất cả khóa học',
      content: `Bạn có chắc muốn xóa tất cả ${itemCount} khóa học trong giỏ hàng?`,
      okText: 'Xóa tất cả',
      cancelText: 'Hủy',
      okType: 'danger',
      onOk: async () => {
        try {
          const cartItemIds = items.map(item => item.id);
          
          // Clear local state first
          clearCart();
          
          // Then call API
          await clearCartService(cartItemIds);
          
        } catch (error) {
          console.error('Clear cart failed:', error);
          // Refresh nếu có lỗi
          refreshCart();
        }
      }
    });
  };

  const handleContinueShopping = () => {
    navigate('/courses');
  };

  const handleCheckoutAll = () => {
    if (itemCount === 0) return;
    
    Modal.info({
      title: 'Tính năng đang phát triển',
      content: 'Tính năng thanh toán tất cả sẽ được cập nhật sớm. Hiện tại bạn có thể mua từng khóa học một.',
    });
  };

  // ✅ RENDER CART ITEM
  const renderCartItem = (item: CartItem) => (
    <List.Item
      className="cart-item"
      actions={[
        <Button
          key="buy"
          type="primary"
          icon={<CreditCardOutlined />}
          onClick={() => handleBuyFromCart(item.id, item.course.title)}
        >
          Mua ngay
        </Button>,
        <Button
          key="remove"
          danger
          icon={<DeleteOutlined />}
          onClick={() => handleRemoveItem(item.id, item.course.title)}
        >
          Xóa
        </Button>
      ]}
    >
      <List.Item.Meta
        avatar={
          <Image
            src={item.course.thumbnailUrl || '/assets/default-course.jpg'}
            alt={item.course.title}
            width={80}
            height={80}
            style={{ borderRadius: 8, objectFit: 'cover' }}
            preview={false}
            fallback="/assets/default-course.jpg"
          />
        }
        title={
          <div className="item-title">
            <Title level={4} ellipsis={{ tooltip: item.course.title }}>
              {item.course.title}
            </Title>
            <Text type="secondary">
              Tác giả: {item.course.authorName}
            </Text>
          </div>
        }
        description={
          <div className="item-description">
            <Text ellipsis={{ tooltip: item.course.description }}>
              {item.course.description}
            </Text>
            <div className="item-meta">
              <Text type="secondary">
                Chủ đề: {item.course.categoryName || 'Chưa phân loại'}
              </Text>
              <br />
              {/* <Text type="secondary">
                Thêm vào giỏ: {formatRelativeTime(item.createdAt)}
              </Text> */}
            </div>
          </div>
        }
      />
      <div className="item-price">
        <Title level={3} style={{ color: '#1890ff', margin: 0 }}>
          {formatPrice(item.course.price)}
        </Title>
      </div>
    </List.Item>
  );

  // ✅ LOADING STATE
  if (isLoading) {
    return (
      <div className="cart-page">
        <Card className="cart-loading">
          <div className="loading-content">
            <span className="loading-spinner" />
            <Title level={4}>Đang tải giỏ hàng...</Title>
          </div>
        </Card>
      </div>
    );
  }

  // ✅ EMPTY STATE
  if (itemCount === 0) {
    return (
      <div className="cart-page">
        <h2>Giỏ hàng trống</h2>
        <Card className="empty-cart">
          <Empty
            image="https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg"
            imageStyle={{ height: 100 }}
            description={
              <div>
                <Title level={4}>Giỏ hàng trống</Title>
                <Text type="secondary">
                  Bạn chưa có khóa học nào trong giỏ hàng. Hãy khám phá các khóa học tuyệt vời!
                </Text>
              </div>
            }
          >
            <Button 
              type="primary" 
              size="large"
              icon={<ShoppingOutlined />}
              onClick={handleContinueShopping}
            >
              Khám phá khóa học
            </Button>
          </Empty>
        </Card>
      </div>
    );
  }

  return (
    <div className="cart-page">
      {/* ✅ PAGE HEADER - Updated to match MemberManagement style */}
      <div className="cart-header-actions">
        <h2>Giỏ hàng ({itemCount})</h2>
        <div className="header-actions">
          <Button 
            icon={<ClearOutlined />}
            onClick={handleClearCart}
            disabled={itemCount === 0}
          >
            Xóa tất cả
          </Button>
          <Button onClick={handleContinueShopping}>
            Tiếp tục mua sắm
          </Button>
        </div>
      </div>

      {/* ✅ CART CONTENT */}
      <div className="cart-content">
        <Card className="cart-items">
          <List
            dataSource={items}
            renderItem={renderCartItem}
            className="cart-list"
          />
        </Card>

        {/* ✅ CART SUMMARY */}
        <Card className="cart-summary" title="Tổng kết giỏ hàng">
          <div className="summary-content">
            <div className="summary-row">
              <Text>Số khóa học:</Text>
              <Text strong>{itemCount}</Text>
            </div>
            
            <div className="summary-row">
              <Text>Tạm tính:</Text>
              <Text strong>{formatPrice(totalAmount)}</Text>
            </div>
            
            <Divider style={{ margin: '12px 0' }} />
            
            <div className="summary-row total-row">
              <Title level={4} style={{ margin: 0 }}>Tổng cộng:</Title>
              <Title level={3} style={{ color: '#1890ff', margin: 0 }}>
                {formatPrice(totalAmount)}
              </Title>
            </div>

            <div className="summary-actions">
              <Button 
                type="primary" 
                size="large" 
                block
                disabled={itemCount === 0}
                icon={<CreditCardOutlined />}
                onClick={handleCheckoutAll}
              >
                Thanh toán tất cả
              </Button>
              
              <Text type="secondary" style={{ textAlign: 'center', fontSize: 12, marginTop: 8 }}>
                Hoặc mua từng khóa học riêng lẻ
              </Text>
            </div>
          </div>
        </Card>
      </div>
    </div>
  );
};

export default CartPage;
/* pages/Cart/Cart.css */

.cart-page {
  margin-left: 270px;
  padding: 20px;
  min-height: calc(100vh - 64px);
  background: #f5f7fa;
  max-width: 1200px;
  margin-right: auto;
  width: 100%;
}

/* ✅ Page Header - Matching MemberManagement style */
.cart-page h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 20px;
  color: #1890ff;
}

.cart-header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.cart-header-actions h2 {
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* ✅ Cart Content Layout */
.cart-content {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 24px;
  align-items: flex-start;
}

.cart-items {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.cart-summary {
  position: sticky;
  top: 24px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ✅ Cart List Items */
.cart-list .ant-list-item {
  padding: 20px;
  border-bottom: 1px solid #f0f0f0;
  align-items: flex-start;
  transition: background-color 0.2s ease;
}

.cart-list .ant-list-item:last-child {
  border-bottom: none;
}

.cart-list .ant-list-item:hover {
  background-color: #fafafa;
}

.item-title {
  margin-bottom: 8px;
}

.item-title .ant-typography {
  margin: 0;
}

.item-description {
  max-width: 400px;
}

.item-meta {
  margin-top: 8px;
}

.item-price {
  margin-left: 20px;
  text-align: center;
  min-width: 120px;
}

/* ✅ Cart Summary */
.summary-content {
  padding: 8px 0;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.total-row {
  margin-bottom: 16px;
  padding: 12px;
  background: #f6ffed;
  border-radius: 6px;
  border: 1px solid #b7eb8f;
}

.summary-actions {
  margin-top: 16px;
}

.summary-actions .ant-btn {
  height: 48px;
  font-size: 16px;
  font-weight: 600;
}

.summary-actions .ant-btn-primary {
  background: #52c41a;
  border-color: #52c41a;
}

.summary-actions .ant-btn-primary:hover {
  background: #73d13d;
  border-color: #73d13d;
}

/* ✅ Empty and Loading States */
.empty-cart,
.cart-loading {
  min-height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #1890ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-cart .ant-empty-description .ant-typography {
  margin: 8px 0;
}

/* ✅ Action Buttons */
.cart-list .ant-list-item-action {
  margin-left: 16px;
  flex-shrink: 0;
}

.cart-list .ant-list-item-action > li {
  padding: 0 8px;
}

.cart-list .ant-list-item-action .ant-btn {
  height: 36px;
  font-size: 14px;
}

/* ✅ Mobile Responsive */
@media (max-width: 768px) {
  .cart-page {
    margin-left: 0;
    padding: 16px;
  }
  
  .cart-header-actions {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .header-actions {
    width: 100%;
    justify-content: center;
  }
  
  .cart-content {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .cart-summary {
    order: -1;
    position: static;
  }
  
  .cart-list .ant-list-item {
    padding: 16px;
    flex-direction: column;
    align-items: stretch;
  }
  
  .cart-list .ant-list-item-meta {
    margin-bottom: 12px;
  }
  
  .cart-list .ant-list-item-action {
    margin-left: 0;
    margin-top: 12px;
  }
  
  .item-price {
    margin-left: 0;
    text-align: left;
    margin-bottom: 12px;
  }
  
  .cart-list .ant-list-item-action > li {
    padding: 0 8px;
  }
}

@media (max-width: 576px) {
  .cart-page {
    padding: 12px;
  }
  
  .header-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .header-actions .ant-btn {
    width: 100%;
  }
  
  .cart-list .ant-list-item-action {
    flex-direction: column;
    gap: 8px;
  }
  
  .cart-list .ant-list-item-action .ant-btn {
    width: 100%;
  }
  
  .summary-actions .ant-btn {
    height: 44px;
    font-size: 15px;
  }
}// pages/Orders/Orders.tsx - Updated with Auto-refresh
import React, { useEffect, useState } from 'react';
import { Card, Typography, Empty, Tabs, Row, Col, Statistic, Select, Input, Button } from 'antd';
import { ShoppingOutlined, ClockCircleOutlined, CheckCircleOutlined, CloseCircleOutlined, SearchOutlined, ReloadOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
// import moment from 'moment';
import useOrderStore from '../../../store/orderStore';
import OrderCard from '../../../components/student/Order/OrderCard/OrderCard'
import type { Order} from '../../../types/order';
import './Orders.css';

const { Title, Text } = Typography;
const { TabPane } = Tabs;
const { Option } = Select;

const OrdersPage: React.FC = () => {
  const navigate = useNavigate();
  
  // ✅ ZUSTAND STATE
  const { 
    orders,
    pendingOrdersCount,
    completedOrdersCount, 
    totalSpent,
    isLoading,
    refreshOrders
  } = useOrderStore();

  // ✅ LOCAL STATE cho filtering
  const [activeTab, setActiveTab] = useState<string>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<string>('createdAt_desc');
  const [refreshing, setRefreshing] = useState(false);

  // ✅ LOAD DATA khi component mount và auto-refresh
  useEffect(() => {
    refreshOrders();
    
    // ✅ Auto refresh mỗi 30s để cập nhật order status từ server
    const interval = setInterval(() => {
      console.log('Auto-refreshing orders...');
      refreshOrders();
    }, 30000); // 30 seconds
    
    return () => clearInterval(interval);
  }, [refreshOrders]);
  
  // ✅ Listen for focus event để refresh khi user quay lại tab
  useEffect(() => {
    const handleFocus = () => {
      console.log('Window focused, refreshing orders...');
      refreshOrders();
    };
    
    const handleVisibilityChange = () => {
      if (!document.hidden) {
        console.log('Tab became visible, refreshing orders...');
        refreshOrders();
      }
    };
    
    window.addEventListener('focus', handleFocus);
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    return () => {
      window.removeEventListener('focus', handleFocus);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [refreshOrders]);

  // ✅ FORMAT PRICE HELPER
  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  // ✅ GET FILTERED ORDERS
  const getFilteredOrders = (): Order[] => {
    let filtered = orders;

    // Filter by tab (status)
    if (activeTab !== 'all') {
      filtered = filtered.filter(order => order.status === activeTab.toUpperCase());
    }

    // Filter by search query
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase().trim();
      filtered = filtered.filter(order => 
        order.detail.course.title.toLowerCase().includes(query) ||
        order.detail.course.authorName?.toLowerCase().includes(query) ||
        order.id.toString().includes(query)
      );
    }

    // Sort orders
    const [field, direction] = sortBy.split('_');
    filtered.sort((a, b) => {
      let aValue: any, bValue: any;
      
      switch (field) {
        case 'createdAt':
          aValue = new Date(a.createdAt).getTime();
          bValue = new Date(b.createdAt).getTime();
          break;
        case 'price':
          aValue = a.detail.priceAtPurchase;
          bValue = b.detail.priceAtPurchase;
          break;
        case 'status':
          aValue = a.status;
          bValue = b.status;
          break;
        default:
          return 0;
      }
      
      if (field === 'status') {
        return direction === 'desc'
          ? String(bValue).localeCompare(String(aValue))
          : String(aValue).localeCompare(String(bValue));
      }
      return direction === 'desc' ? Number(bValue) - Number(aValue) : Number(aValue) - Number(bValue);
    });

    return filtered;
  };

  // ✅ EVENT HANDLERS
  const handleTabChange = (key: string) => {
    setActiveTab(key);
  };

  const handleContinueShopping = () => {
    navigate('/courses');
  };

  // ✅ MANUAL REFRESH HANDLER
  const handleManualRefresh = async () => {
    setRefreshing(true);
    try {
      await refreshOrders();
    } finally {
      setRefreshing(false);
    }
  };

  const filteredOrders = getFilteredOrders();

  // ✅ RENDER FILTERS & CONTROLS
  const renderFiltersAndControls = () => (
    <Card className="order-controls" style={{ marginBottom: 24 }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 16 }}>
        <div style={{ display: 'flex', gap: 16, alignItems: 'center', flex: 1, minWidth: 300 }}>
          <Input
            placeholder="Tìm kiếm theo tên khóa học, tác giả hoặc mã đơn hàng..."
            prefix={<SearchOutlined />}
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            style={{ flex: 1, maxWidth: 300 }}
            allowClear
          />
          
          <Select
            value={sortBy}
            onChange={setSortBy}
            style={{ width: 180 }}
            placeholder="Sắp xếp theo"
          >
            <Option value="createdAt_desc">Mới nhất</Option>
            <Option value="createdAt_asc">Cũ nhất</Option>
            <Option value="price_desc">Giá cao nhất</Option>
            <Option value="price_asc">Giá thấp nhất</Option>
            <Option value="status_asc">Trạng thái A-Z</Option>
          </Select>
        </div>
        
        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
          <Button 
            icon={<ReloadOutlined />}
            onClick={handleManualRefresh}
            loading={refreshing}
            title="Làm mới danh sách đơn hàng"
          >
            Làm mới
          </Button>
          
          {/* ✅ Auto-refresh indicator */}
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            gap: 4, 
            color: '#52c41a',
            fontSize: 12 
          }}>
            <div style={{ 
              width: 8, 
              height: 8, 
              borderRadius: '50%', 
              backgroundColor: '#52c41a',
              animation: 'pulse 2s infinite'
            }} />
            Tự động cập nhật
          </div>
        </div>
      </div>
    </Card>
  );

  // ✅ RENDER ORDER STATISTICS
  const renderOrderStatistics = () => (
    <Card className="order-statistics" style={{ marginBottom: 24 }}>
      <Row gutter={16}>
        <Col xs={12} sm={6}>
          <Statistic 
            title="Tổng đơn hàng" 
            value={orders.length} 
            prefix={<ShoppingOutlined />} 
          />
        </Col>
        <Col xs={12} sm={6}>
          <Statistic 
            title="Đang chờ" 
            value={pendingOrdersCount} 
            prefix={<ClockCircleOutlined />}
            valueStyle={{ color: '#faad14' }}
          />
        </Col>
        <Col xs={12} sm={6}>
          <Statistic 
            title="Hoàn thành" 
            value={completedOrdersCount} 
            prefix={<CheckCircleOutlined />}
            valueStyle={{ color: '#52c41a' }}
          />
        </Col>
        <Col xs={12} sm={6}>
          <Statistic 
            title="Tổng chi tiêu" 
            value={formatPrice(totalSpent)}
            valueStyle={{ color: '#1890ff' }}
          />
        </Col>
      </Row>
    </Card>
  );

  // ✅ RENDER ORDER LIST
  const renderOrderList = (orderList: Order[]) => {
    if (orderList.length === 0) {
      const emptyMessage = activeTab === 'all' 
        ? 'Bạn chưa có đơn hàng nào'
        : `Không có đơn hàng ${activeTab === 'pending' ? 'đang chờ' : activeTab === 'completed' ? 'hoàn thành' : 'bị hủy'}`;
        
      return (
        <Card className="empty-orders">
          <Empty
            image={Empty.PRESENTED_IMAGE_SIMPLE}
            description={emptyMessage}
          >
            <Button type="primary" onClick={handleContinueShopping}>
              Mua khóa học ngay
            </Button>
          </Empty>
        </Card>
      );
    }

    return (
      <div className="order-list">
        <Row gutter={[16, 16]}>
          {orderList.map(order => (
            <Col key={order.id} xs={24} sm={24} md={12} lg={8}>
              <OrderCard order={order} />
            </Col>
          ))}
        </Row>
      </div>
    );
  };

  // ✅ LOADING STATE
  if (isLoading && orders.length === 0) {
    return (
      <div className="orders-page">
        <Card className="loading-container">
          <div className="loading-content">
            <span className="loading-spinner" />
            <Title level={4}>Đang tải đơn hàng...</Title>
          </div>
        </Card>
      </div>
    );
  }

  return (
    <div className="orders-page">
      {/* ✅ PAGE HEADER */}
      <Card className="orders-header">
        <div className="header-content">
          <Title level={2} style={{ margin: 0 }}>
            Lịch sử đơn hàng
          </Title>
          <Text type="secondary">
            Quản lý và theo dõi tất cả đơn hàng của bạn
          </Text>
        </div>
      </Card>

      {/* ✅ ORDER STATISTICS */}
      {renderOrderStatistics()}

      {/* ✅ FILTERS & CONTROLS */}
      {renderFiltersAndControls()}

      {/* ✅ ORDER TABS */}
      <Card className="orders-content">
        <Tabs 
          activeKey={activeTab} 
          onChange={handleTabChange}
          className="order-tabs"
        >
          <TabPane 
            tab={<span><ShoppingOutlined />Tất cả ({orders.length})</span>} 
            key="all"
          >
            {renderOrderList(filteredOrders)}
          </TabPane>
          
          <TabPane 
            tab={<span><ClockCircleOutlined />Đang chờ ({pendingOrdersCount})</span>} 
            key="pending"
          >
            {renderOrderList(filteredOrders)}
          </TabPane>
          
          <TabPane 
            tab={<span><CheckCircleOutlined />Hoàn thành ({completedOrdersCount})</span>} 
            key="completed"
          >
            {renderOrderList(filteredOrders)}
          </TabPane>
          
          <TabPane 
            tab={<span><CloseCircleOutlined />Đã hủy</span>} 
            key="cancelled"
          >
            {renderOrderList(filteredOrders)}
          </TabPane>
        </Tabs>
      </Card>
    </div>
  );
};

export default OrdersPage;/* pages/Orders/Orders.css */

.orders-page {
  min-height: calc(100vh - 64px); 
  background: #f5f7fa;
  padding: 24px;
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  margin-left: 270px; /* Account for sidebar */
}

/* ✅ Page Header */
.orders-header {
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  text-align: center;
}

.header-content {
  padding: 8px 0;
}

/* ✅ Statistics Section */
.order-statistics {
  margin-bottom: 24px;
}

.order-statistics .ant-card {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  transition: all 0.2s ease;
}

.order-statistics .ant-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.order-statistics .ant-statistic {
  text-align: center;
}

.order-statistics .ant-statistic-title {
  font-size: 12px;
  color: #8c8c8c;
  margin-bottom: 4px;
}

.order-statistics .ant-statistic-content {
  font-size: 20px;
  font-weight: 600;
}

/* ✅ Filters Section */
.order-filters {
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

.order-filters .ant-space {
  width: 100%;
  justify-content: space-between;
}

/* ✅ Orders Content */
.orders-content {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

/* ✅ Order Tabs */
.order-tabs .ant-tabs-tab {
  font-weight: 500;
  padding: 12px 16px;
  border-radius: 6px 6px 0 0;
  transition: all 0.2s ease;
}

.order-tabs .ant-tabs-tab:hover {
  color: #40a9ff;
}

.order-tabs .ant-tabs-tab-active {
  background: #e6f7ff;
  color: #1890ff;
  font-weight: 600;
}

.order-tabs .ant-tabs-content {
  padding: 16px 0;
}

/* ✅ Order List */
.order-list {
  min-height: 300px;
  padding: 16px 0;
}

.order-list .ant-row {
  margin-left: -8px;
  margin-right: -8px;
}

.order-list .ant-col {
  padding-left: 8px;
  padding-right: 8px;
  margin-bottom: 16px;
}

/* ✅ Empty States */
.empty-orders {
  min-height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  background: #fafafa;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
}

.empty-orders .ant-empty {
  margin: 0;
}

.empty-orders .ant-empty-description {
  color: #8c8c8c;
  font-size: 14px;
  margin-bottom: 16px;
}

.empty-orders .ant-btn {
  background: #1890ff;
  border-color: #1890ff;
  color: #fff;
  font-weight: 600;
  height: 40px;
  padding: 0 24px;
}

/* ✅ Loading State */
.loading-container {
  min-height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

.loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #1890ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ✅ Responsive Design */
@media (max-width: 768px) {
  .orders-page {
    margin-left: 0;
    padding: 16px;
  }
  
  .orders-header {
    margin-bottom: 16px;
    padding: 16px;
  }
  
  .header-content {
    padding: 0;
  }
  
  .order-statistics {
    margin-bottom: 16px;
  }
  
  .order-statistics .ant-col {
    margin-bottom: 8px;
  }
  
  .order-statistics .ant-statistic-content {
    font-size: 18px;
  }
  
  .order-filters {
    margin-bottom: 16px;
  }
  
  .order-filters .ant-space {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .order-filters .ant-input {
    width: 100%;
  }
  
  .order-filters .ant-select {
    width: 100%;
  }
  
  .order-tabs .ant-tabs-tab {
    padding: 8px 12px;
    font-size: 12px;
  }
  
  .order-list .ant-col {
    margin-bottom: 12px;
    padding-left: 4px;
    padding-right: 4px;
  }
}

@media (max-width: 576px) {
  .orders-page {
    padding: 12px;
  }
  
  .order-statistics .ant-row {
    margin: 0 -4px;
  }
  
  .order-statistics .ant-col {
    padding: 0 4px;
    margin-bottom: 8px;
  }
  
  .order-statistics .ant-statistic-title {
    font-size: 11px;
  }
  
  .order-statistics .ant-statistic-content {
    font-size: 16px;
  }
  
  .order-filters .ant-space {
    gap: 8px;
  }
  
  .order-tabs .ant-tabs-nav {
    margin-bottom: 8px;
  }
  
  .order-tabs .ant-tabs-tab {
    padding: 6px 8px;
    font-size: 11px;
  }
  
  .order-tabs .anticon {
    font-size: 12px;
  }
  
  .order-list .ant-col {
    padding: 0 2px;
    margin-bottom: 8px;
  }
  
  .empty-orders {
    min-height: 200px;
    padding: 20px;
  }
  
  .empty-orders .ant-empty-description {
    font-size: 12px;
  }
  
  .empty-orders .ant-btn {
    height: 36px;
    padding: 0 16px;
    font-size: 14px;
  }
}

/* Thêm vào cuối file pages/Orders/Orders.css */

/* ✅ Order Controls */
.order-controls {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

.order-controls .ant-input {
  border-radius: 6px;
}

.order-controls .ant-select .ant-select-selector {
  border-radius: 6px;
}

/* ✅ Auto-refresh indicator animation */
@keyframes pulse {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.2);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* ✅ Manual refresh button */
.order-controls .ant-btn {
  height: 32px;
  border-radius: 6px;
}

.order-controls .ant-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* ✅ Order Statistics enhancements */
.order-statistics .ant-statistic-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.order-statistics .ant-statistic-content .anticon {
  color: inherit;
}

/* ✅ Loading state for refresh */
.orders-content.refreshing {
  opacity: 0.7;
  pointer-events: none;
}

/* ✅ Mobile responsive adjustments */
@media (max-width: 768px) {
  .order-controls > div {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 12px !important;
  }
  
  .order-controls .ant-input {
    width: 100% !important;
    max-width: none !important;
  }
  
  .order-controls .ant-select {
    width: 100% !important;
  }
  
  .order-controls > div > div:last-child {
    justify-content: center !important;
  }
}// pages/OrderStatus/OrderStatus.tsx
import React, { useEffect, useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { Card, Result, Button, Spin, Typography, Descriptions } from 'antd';
import { CheckCircleOutlined, CloseCircleOutlined, ShoppingOutlined, EyeOutlined } from '@ant-design/icons';
import { parsePaymentCallback, formatPaymentAmount } from '../../../services/paymentService';
import useOrderStore from '../../../store/orderStore';
import useCartStore from '../../../store/cartStore';
import './OrderStatus.css';

const { Title, Text } = Typography;

/**
 * ✅ ORDER STATUS PAGE
 * 
 * Xử lý callback từ VNPay sau khi thanh toán:
 * /order-status?status=success&txnRef=20250821160529_7&transactionNo=15141156&amount=12312300&payDate=20250821160807
 */

const OrderStatusPage: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  
  // ✅ ZUSTAND STORES
  const { refreshOrders } = useOrderStore();
  const { refreshCart } = useCartStore();
  
  // ✅ LOCAL STATE
  const [loading, setLoading] = useState(true);
  const [paymentData, setPaymentData] = useState<any>(null);

  // ✅ PARSE PAYMENT CALLBACK khi component mount
  useEffect(() => {
    const handlePaymentCallback = async () => {
      try {
        setLoading(true);
        
        // ✅ Parse URL parameters
        const params = parsePaymentCallback(location.search);
        
        if (!params.status || !params.txnRef) {
          throw new Error('Invalid payment callback parameters');
        }
        
        // ✅ Set payment data
        setPaymentData({
          ...params,
          formattedAmount: formatPaymentAmount(params.amount)
        });
        
        // ✅ Nếu thanh toán thành công, refresh data
        if (params.status === 'success') {
          // ✅ Update order status trước
          const { updateOrderAfterPayment } = await import('../../../services/paymentService');
          await updateOrderAfterPayment(params.txnRef, {
            ...params,
            formattedAmount: formatPaymentAmount(params.amount)
          });
          
          // Refresh orders để lấy thông tin order mới nhất
          await refreshOrders();
          
          // Refresh cart để xóa item đã mua (nếu có)
          await refreshCart();
        }
        
      } catch (error) {
        console.error('Payment callback handling failed:', error);
        setPaymentData({ status: 'error', error: 'Có lỗi xảy ra khi xử lý thông tin thanh toán' });
      } finally {
        setLoading(false);
      }
    };

    handlePaymentCallback();
  }, [location.search, refreshOrders, refreshCart]);

  // ✅ EVENT HANDLERS
  const handleViewOrders = () => {
    navigate('/dashboard/orders');
  };

  const handleViewCourses = () => {
    navigate('/dashboard/video-courses');
  };

  const handleBackToShopping = () => {
    navigate('/courses');
  };

  // ✅ FORMAT HELPERS
  const formatPrice = (amount: number) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(amount);
  };

  const formatDateTime = (dateString: string) => {
    if (!dateString || dateString.length !== 14) return 'Không xác định';
    
    // Format: YYYYMMDDHHmmss -> DD/MM/YYYY HH:mm:ss
    const year = dateString.substring(0, 4);
    const month = dateString.substring(4, 6);
    const day = dateString.substring(6, 8);
    const hour = dateString.substring(8, 10);
    const minute = dateString.substring(10, 12);
    const second = dateString.substring(12, 14);
    
    return `${day}/${month}/${year} ${hour}:${minute}:${second}`;
  };

  // ✅ LOADING STATE
  if (loading) {
    return (
      <div className="order-status-page">
        <Card className="status-card">
          <div className="loading-container">
            <Spin size="large" />
            <Title level={4} style={{ marginTop: 16 }}>
              Đang xử lý thông tin thanh toán...
            </Title>
            <Text type="secondary">Vui lòng chờ trong giây lát</Text>
          </div>
        </Card>
      </div>
    );
  }

  // ✅ ERROR STATE
  if (!paymentData || paymentData.status === 'error') {
    return (
      <div className="order-status-page">
        <Card className="status-card">
          <Result
            status="error"
            title="Lỗi xử lý thanh toán"
            subTitle={paymentData?.error || 'Không thể xử lý thông tin thanh toán. Vui lòng kiểm tra lại đơn hàng.'}
            extra={[
              <Button type="primary" key="orders" onClick={handleViewOrders}>
                Xem đơn hàng
              </Button>,
              <Button key="shopping" onClick={handleBackToShopping}>
                Tiếp tục mua sắm
              </Button>
            ]}
          />
        </Card>
      </div>
    );
  }

  // ✅ SUCCESS STATE
  if (paymentData.status === 'success') {
    return (
      <div className="order-status-page">
        <Card className="status-card">
          <Result
            status="success"
            title="Thanh toán thành công!"
            subTitle="Đơn hàng của bạn đã được thanh toán thành công. Bạn có thể truy cập khóa học ngay bây giờ."
            icon={<CheckCircleOutlined style={{ color: '#52c41a' }} />}
            extra={[
              <Button type="primary" key="courses" icon={<EyeOutlined />} onClick={handleViewCourses}>
                Xem khóa học đã mua
              </Button>,
              <Button key="orders" onClick={handleViewOrders}>
                Xem đơn hàng
              </Button>,
              <Button key="shopping" icon={<ShoppingOutlined />} onClick={handleBackToShopping}>
                Tiếp tục mua sắm
              </Button>
            ]}
          />
          
          {/* ✅ PAYMENT DETAILS */}
          <Card 
            title="Chi tiết thanh toán" 
            style={{ marginTop: 24 }}
            size="small"
          >
            <Descriptions column={1} size="small">
              <Descriptions.Item label="Mã giao dịch">
                <Text code>{paymentData.txnRef}</Text>
              </Descriptions.Item>
              <Descriptions.Item label="Số giao dịch VNPay">
                <Text code>{paymentData.transactionNo}</Text>
              </Descriptions.Item>
              <Descriptions.Item label="Số tiền">
                <Text strong style={{ color: '#52c41a', fontSize: 16 }}>
                  {formatPrice(paymentData.formattedAmount)}
                </Text>
              </Descriptions.Item>
              <Descriptions.Item label="Thời gian thanh toán">
                {formatDateTime(paymentData.payDate)}
              </Descriptions.Item>
              <Descriptions.Item label="Trạng thái">
                <Text style={{ color: '#52c41a', fontWeight: 'bold' }}>
                  Thành công
                </Text>
              </Descriptions.Item>
            </Descriptions>
          </Card>
        </Card>
      </div>
    );
  }

  // ✅ FAILED STATE
  return (
    <div className="order-status-page">
      <Card className="status-card">
        <Result
          status="error"
          title="Thanh toán thất bại"
          subTitle="Đơn hàng của bạn chưa được thanh toán thành công. Vui lòng thử lại hoặc liên hệ hỗ trợ."
          icon={<CloseCircleOutlined style={{ color: '#ff4d4f' }} />}
          extra={[
            <Button type="primary" key="retry" onClick={handleViewOrders}>
              Thử thanh toán lại
            </Button>,
            <Button key="shopping" onClick={handleBackToShopping}>
              Tiếp tục mua sắm
            </Button>
          ]}
        />
        
        {/* ✅ FAILED PAYMENT DETAILS */}
        {paymentData.txnRef && (
          <Card 
            title="Chi tiết giao dịch" 
            style={{ marginTop: 24 }}
            size="small"
          >
            <Descriptions column={1} size="small">
              <Descriptions.Item label="Mã giao dịch">
                <Text code>{paymentData.txnRef}</Text>
              </Descriptions.Item>
              {paymentData.amount && (
                <Descriptions.Item label="Số tiền">
                  {formatPrice(paymentData.formattedAmount)}
                </Descriptions.Item>
              )}
              <Descriptions.Item label="Trạng thái">
                <Text style={{ color: '#ff4d4f', fontWeight: 'bold' }}>
                  Thất bại
                </Text>
              </Descriptions.Item>
            </Descriptions>
          </Card>
        )}
      </Card>
    </div>
  );
};

export default OrderStatusPage;/* pages/OrderStatus/OrderStatus.css */

.order-status-page {
  min-height: calc(100vh - 64px);
  background: #f5f7fa;
  padding: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ✅ Main Status Card */
.status-card {
  width: 100%;
  max-width: 600px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  text-align: center;
}

/* ✅ Loading Container */
.loading-container {
  padding: 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* ✅ Result Component Customization */
.status-card .ant-result {
  padding: 40px 20px 20px;
}

.status-card .ant-result-title {
  color: #262626;
  font-weight: 600;
  margin-bottom: 8px;
}

.status-card .ant-result-subtitle {
  color: #595959;
  font-size: 14px;
  line-height: 1.6;
}

/* ✅ Success State */
.status-card .ant-result-success .ant-result-icon {
  color: #52c41a;
}

.status-card .ant-result-success .ant-result-title {
  color: #52c41a;
}

/* ✅ Error State */
.status-card .ant-result-error .ant-result-icon {
  color: #ff4d4f;
}

.status-card .ant-result-error .ant-result-title {
  color: #ff4d4f;
}

/* ✅ Action Buttons */
.status-card .ant-result-extra {
  margin-top: 24px;
}

.status-card .ant-result-extra .ant-btn {
  margin: 4px 8px;
  height: 40px;
  padding: 0 20px;
  font-weight: 500;
  border-radius: 6px;
}

.status-card .ant-result-extra .ant-btn-primary {
  background: #1890ff;
  border-color: #1890ff;
}

.status-card .ant-result-extra .ant-btn-primary:hover {
  background: #40a9ff;
  border-color: #40a9ff;
}

/* ✅ Payment Details Card */
.status-card .ant-card {
  border: 1px solid #f0f0f0;
  border-radius: 8px;
}

.status-card .ant-card-head {
  background: #fafafa;
  border-bottom: 1px solid #f0f0f0;
}

.status-card .ant-card-head-title {
  color: #262626;
  font-weight: 600;
  font-size: 16px;
}

/* ✅ Descriptions Styling */
.status-card .ant-descriptions-item-label {
  color: #8c8c8c;
  font-weight: 500;
  width: 140px;
}

.status-card .ant-descriptions-item-content {
  color: #262626;
}

/* ✅ Code Text */
.status-card .ant-typography code {
  background: #f6f8fa;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 12px;
}

/* ✅ Mobile Responsive */
@media (max-width: 768px) {
  .order-status-page {
    padding: 16px;
  }
  
  .status-card {
    max-width: 100%;
  }
  
  .status-card .ant-result {
    padding: 24px 16px 16px;
  }
  
  .status-card .ant-result-title {
    font-size: 20px;
  }
  
  .status-card .ant-result-subtitle {
    font-size: 13px;
  }
  
  .status-card .ant-result-extra .ant-btn {
    margin: 4px 4px;
    padding: 0 16px;
    height: 36px;
    font-size: 14px;
  }
  
  .status-card .ant-descriptions-item-label {
    width: 120px;
    font-size: 13px;
  }
  
  .status-card .ant-descriptions-item-content {
    font-size: 13px;
  }
}

@media (max-width: 576px) {
  .order-status-page {
    padding: 12px;
  }
  
  .status-card .ant-result-extra {
    margin-top: 16px;
  }
  
  .status-card .ant-result-extra .ant-btn {
    width: 100%;
    margin: 4px 0;
  }
  
  .status-card .ant-descriptions-item-label {
    width: 100px;
    font-size: 12px;
  }
  
  .status-card .ant-descriptions-item-content {
    font-size: 12px;
  }
}

/* ✅ Animation for success state */
@keyframes successPulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

.status-card .ant-result-success .ant-result-icon {
  animation: successPulse 2s ease-in-out;
}// pages/CourseManagement/CourseManagement.tsx - Cải thiện
import { Button, message, Table, Input, Select, DatePicker, Form, Switch, Modal } from 'antd';
import { useEffect, useState, useCallback } from 'react';
import { getAllCoursesService, updateCourseStatusService, getCategoriesService } from '../../../services/courseManagementService';
import moment from 'moment';
import './CourseManagement.css';
import type { AllCoursesRequest, Course, Category } from '../../../types/course';
import type { SortOrder } from 'antd/es/table/interface';
import CourseDetailDrawer from '../../../components/manage/CourseManagement/CourseDetailDrawer/CourseDetailDrawer';

const { Option } = Select;
const { RangePicker } = DatePicker;

const CourseManagement = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [courses, setCourses] = useState<Course[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [currentPage, setCurrentPage] = useState(0);
  const [pageSize, setPageSize] = useState(5);
  // const [totalPages, setTotalPages] = useState(0);
  const [totalElements, setTotalElements] = useState(0);
  const [sortField, setSortField] = useState<string | null>(null);
  const [sortOrder, setSortOrder] = useState<SortOrder | undefined>(undefined);
  const [modalLoading, setModalLoading] = useState(false);
  const [modalState, setModalState] = useState({
    activeOpen: false,
    activeChecked: false,
    deleteOpen: false,
    isDelete: false,
    courseId: null as number | null,
  });
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [selectedCourse, setSelectedCourse] = useState<Course | null>(null);

  const fetchCategories = useCallback(async () => {
    try {
      const response = await getCategoriesService();
      if (response.code === 200) {
        setCategories(response.data);
      }
    } catch (error) {
      console.error('Lỗi khi lấy danh sách danh mục:', error);
    }
  }, []);

  const fetchCourses = useCallback(
    async (values: any = {}, page: number = 0, size: number = 5, sort: string | null = null) => {
      setLoading(true);
      try {
        const { title, dateRange, categories } = values;
        const dataBody: AllCoursesRequest = {
          fromDate: dateRange?.[0] ? dateRange[0].format('YYYY-MM-DD') : null,
          toDate: dateRange?.[1] ? dateRange[1].format('YYYY-MM-DD') : null,
          title: title || null,
          categories: categories ? [categories] : [],
          page,
          size,
          sort,
        };
        const response = await getAllCoursesService(dataBody);
        setCourses(response.data.content);
        // setTotalPages(response.data.totalPages);
        setTotalElements(response.data.totalElements);
        setCurrentPage(response.data.pageable.pageNumber);
      } catch (error) {
        console.error('Lỗi khi lấy danh sách khóa học:', error);
      } finally {
        setLoading(false);
      }
    },
    []
  );

  useEffect(() => {
    fetchCategories();
  }, []);

  useEffect(() => {
    fetchCourses();
  }, [fetchCourses]);

  const handleToggleActive = useCallback((courseId: number, checked: boolean) => {
    setModalState(prev => ({
      ...prev,
      activeOpen: true,
      activeChecked: checked,
      courseId,
    }));
  }, []);

  // ✅ Cải thiện handleModalActiveOk
  const handleModalActiveOk = async () => {
    if (modalState.courseId === null) return;
    setModalLoading(true);
    try {
      const response = await updateCourseStatusService({
        id: modalState.courseId,
        isActive: modalState.activeChecked,
      });
      if (response.code === 200) {
        message.success(modalState.activeChecked ? 'Duyệt khóa học thành công!' : 'Hủy duyệt khóa học thành công!');
        setCourses(courses.map(course => 
          course.id === modalState.courseId 
            ? { ...course, isActive: modalState.activeChecked } 
            : course
        ));
      }
    } catch (error) {
      console.error('Lỗi khi cập nhật trạng thái khóa học:', error);
    } finally {
      setModalLoading(false);
      setModalState(prev => ({ ...prev, activeOpen: false, courseId: null }));
    }
  };

  const handleModalActiveCancel = () => {
    setModalState(prev => ({ ...prev, activeOpen: false, courseId: null }));
  };

  const handleDeleteOrRestore = useCallback((courseId: number, isDelete: boolean) => {
    setModalState(prev => ({
      ...prev,
      deleteOpen: true,
      isDelete,
      courseId,
    }));
  }, []);

  // ✅ Cải thiện handleModalDeleteOk
  const handleModalDeleteOk = async () => {
    if (modalState.courseId === null) return;
    setModalLoading(true);
    try {
      const response = await updateCourseStatusService({
        id: modalState.courseId,
        isDelete: modalState.isDelete,
        ...(modalState.isDelete && { isActive: false }), // ✅ Chỉ set isActive = false khi xóa
      });
      if (response.code === 200) {
        message.success(modalState.isDelete ? 'Xóa khóa học thành công!' : 'Khôi phục khóa học thành công!');
        setCourses(courses.map(course =>
          course.id === modalState.courseId
            ? { 
                ...course, 
                isDelete: modalState.isDelete, 
                isActive: modalState.isDelete ? false : course.isActive 
              }
            : course
        ));
      }
    } catch (error) {
      console.error(modalState.isDelete ? 'Lỗi khi xóa khóa học:' : 'Lỗi khi khôi phục khóa học:', error);
    } finally {
      setModalLoading(false);
      setModalState(prev => ({ ...prev, deleteOpen: false, courseId: null }));
    }
  };

  const handleModalDeleteCancel = () => {
    setModalState(prev => ({ ...prev, deleteOpen: false, courseId: null }));
  };

  const handleTableChange = (pagination: any, _filters: any, sorter: any) => {
    const { field, order } = sorter;
    const newSortField = field || null;
    const newSortOrder = order as SortOrder;
    setSortField(newSortField);
    setSortOrder(newSortOrder);
    setCurrentPage(pagination.current - 1);
    setPageSize(pagination.pageSize);
    fetchCourses(
      form.getFieldsValue(),
      pagination.current - 1,
      pagination.pageSize,
      newSortField && newSortOrder ? `${newSortField},${newSortOrder === 'ascend' ? 'asc' : 'desc'}` : null
    );
  };

  const handleRowClick = (record: Course) => {
    setSelectedCourse(record);
    setDrawerOpen(true);
  };

  const handleCreateCourse = () => {
    setSelectedCourse(null);
    setDrawerOpen(true);
  };

  const handleDrawerClose = () => {
    setDrawerOpen(false);
    setSelectedCourse(null);
  };

  const columns = [
    {
      title: 'Tiêu đề',
      dataIndex: 'title',
      key: 'title',
      width: 200,
      ellipsis: true,
      sorter: true,
      sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
      sortOrder: sortField === 'title' ? sortOrder : undefined,
    },
    {
      title: 'Giá (VND)',
      dataIndex: 'price',
      key: 'price',
      width: 120,
      sorter: true,
      sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
      sortOrder: sortField === 'price' ? sortOrder : undefined,
    },
    {
      title: 'Chủ đề',
      dataIndex: 'categoryName',
      key: 'categoryName',
      width: 150,
      render: (categoryName: string) => categoryName || 'Chưa xác định',
    },
    {
      title: 'Tác giả',
      dataIndex: 'authorName',
      key: 'authorName',
      width: 150,
      render: (authorName: string) => authorName || 'Chưa xác định',
    },
    {
      title: 'Ngày tạo',
      dataIndex: 'createdAt',
      key: 'createdAt',
      width: 150,
      render: (createdAt: string) => moment(createdAt).format('DD/MM/YYYY HH:mm'),
      sorter: true,
      sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
      sortOrder: sortField === 'createdAt' ? sortOrder : undefined,
    },
    {
      title: 'Trạng thái',
      dataIndex: 'isActive',
      key: 'isActive',
      width: 100,
      render: (isActive: boolean, record: Course) => (
        <Switch
          checked={isActive}
          onChange={(checked) => handleToggleActive(record.id, checked)}
          disabled={record.isDelete}
          aria-label={`Bật/tắt trạng thái cho khóa học ${record.title}`}
          onClick={(_checked, e) => e.stopPropagation()} // ✅ Ngăn event bubbling
        />
      ),
    },
    {
      title: 'Hành động',
      key: 'action',
      width: 150,
      render: (_: any, record: Course) => (
        <div className="action-buttons" onClick={(e) => e.stopPropagation()}> {/* ✅ Ngăn event bubbling */}
          {record.isDelete ? (
            <Button 
              size="small" 
              onClick={(e) => {
                e.stopPropagation(); // ✅ Ngăn event bubbling
                handleDeleteOrRestore(record.id, false);
              }}
            >
              Khôi phục
            </Button>
          ) : (
            <Button
              danger
              size="small"
              onClick={(e) => {
                e.stopPropagation(); // ✅ Ngăn event bubbling
                handleDeleteOrRestore(record.id, true);
              }}
            >
              Xóa
            </Button>
          )}
        </div>
      ),
    },
  ];

  return (
    <div className="course-management">
      <h2>Quản Lý Khóa Học</h2>
      <Form
        form={form}
        layout="inline"
        onFinish={(values) =>
          fetchCourses(
            values,
            0,
            pageSize,
            sortField && sortOrder ? `${sortField},${sortOrder === 'ascend' ? 'asc' : 'desc'}` : null
          )
        }
        style={{ marginBottom: 16 }}
        className="search-form"
      >
        <Form.Item name="title" label="Tiêu đề">
          <Input placeholder="Nhập tiêu đề khóa học" />
        </Form.Item>
        <Form.Item name="categories" label="Chủ đề">
          <Select placeholder="Chọn chủ đề" allowClear>
            {categories.map(category => (
              <Option key={category.id} value={category.name}>
                {category.name}
              </Option>
            ))}
          </Select>
        </Form.Item>
        <Form.Item name="dateRange" label="Ngày tạo khóa học">
          <RangePicker format="DD/MM/YYYY" />
        </Form.Item>
        <div className="form-actions">
          <Form.Item>
            <Button type="primary" htmlType="submit" onClick={() => setCurrentPage(0)}>
              Tìm kiếm
            </Button>
          </Form.Item>
          <Form.Item>
            <Button onClick={() => { 
              form.resetFields(); 
              setSortField(null); 
              setSortOrder(undefined); 
              fetchCourses({}, 0, pageSize, null); 
            }}>
              Xóa bộ lọc
            </Button>
          </Form.Item>
          <Form.Item>
            <Button type="primary" onClick={handleCreateCourse}>
              Tạo khóa học
            </Button>
          </Form.Item>
        </div>
      </Form>
      <Table
        columns={columns}
        dataSource={courses}
        loading={loading}
        rowKey="id" // ✅ Thêm rowKey
        pagination={{
          current: currentPage + 1,
          pageSize: pageSize,
          total: totalElements,
          showSizeChanger: true,
          pageSizeOptions: ['5', '10', '20', '50'],
          showTotal: (total, range) => `${range[0]}-${range[1]} của ${total} khóa học`, // ✅ Hiển thị tổng số
        }}
        onChange={handleTableChange}
        rowClassName={(record) => record.isDelete ? 'deleted-row' : ''} // ✅ Class cho row bị xóa
        onRow={(record) => ({
          onClick: () => handleRowClick(record),
          style: { cursor: 'pointer' },
        })}
      />
      <Modal
        title={modalState.activeChecked ? 'Xác nhận duyệt khóa học' : 'Xác nhận hủy duyệt khóa học'}
        open={modalState.activeOpen}
        onOk={handleModalActiveOk}
        onCancel={handleModalActiveCancel}
        okText="Xác nhận"
        cancelText="Hủy"
        confirmLoading={modalLoading}
      >
        <p>
          {modalState.activeChecked
            ? 'Bạn có chắc chắn muốn duyệt khóa học này?'
            : 'Bạn có chắc chắn muốn hủy duyệt khóa học này?'}
        </p>
      </Modal>
      <Modal
        title={modalState.isDelete ? 'Xác nhận xóa khóa học' : 'Xác nhận khôi phục khóa học'}
        open={modalState.deleteOpen}
        onOk={handleModalDeleteOk}
        onCancel={handleModalDeleteCancel}
        okText="Xác nhận"
        cancelText="Hủy"
        okType={modalState.isDelete ? 'danger' : 'primary'}
        confirmLoading={modalLoading}
      >
        <p>
          {modalState.isDelete
            ? 'Bạn có chắc chắn muốn xóa khóa học này? Hành động này không thể hoàn tác.'
            : 'Bạn có chắc chắn muốn khôi phục khóa học này?'}
        </p>
      </Modal>
      <CourseDetailDrawer
        open={drawerOpen}
        onClose={handleDrawerClose}
        course={selectedCourse}
        categories={categories}
        onCourseUpdated={() => fetchCourses(form.getFieldsValue(), currentPage, pageSize, sortField && sortOrder ? `${sortField},${sortOrder === 'ascend' ? 'asc' : 'desc'}` : null)}
      />
    </div>
  );
};

export default CourseManagement;.course-management {
  margin-left: 270px;
  padding: 20px;
  min-height: calc(100vh - 64px);
  background: #f5f7fa;
}

.course-management .header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.course-management h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 0;
  color: #1890ff;
}

.course-management .ant-form {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.course-management .ant-form-item {
  margin-bottom: 0;
}

.course-management .ant-input,
.course-management .ant-select,
.course-management .ant-picker {
  width: 180px;
}

.course-management .ant-table {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.course-management .ant-table-thead > tr > th {
  background: #fafafa;
  font-weight: 600;
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.action-buttons .ant-btn {
  height: 32px;
  font-size: 14px;
}

.form-actions {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
  align-items: center;
}

@media (max-width: 768px) {
  .course-management {
    margin-left: 0;
    padding: 16px;
  }

  .course-management .ant-form {
    flex-direction: column;
  }

  .course-management .ant-input,
  .course-management .ant-select,
  .course-management .ant-picker {
    width: 100%;
  }

  .form-actions {
    flex-direction: column;
    gap: 12px;
    width: 100%;
  }

  .form-actions .ant-btn {
    width: 100%;
  }
}import { Button, message, Table, Input, Select, DatePicker, Form, Switch, Modal } from 'antd';
import { useEffect, useState, useCallback } from 'react';
import moment from 'moment';
import { filterUsersService, disableUserService, deleteUserService } from '../../../services/userService';
import './MemberManagement.css';
import type { FilterRequest, User, FilterResponse } from '../../../types/user';
import type { SortOrder } from 'antd/es/table/interface';

const { Option } = Select;
const { RangePicker } = DatePicker;

const MemberManagement = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [users, setUsers] = useState<User[]>([]);
  const [currentPage, setCurrentPage] = useState(0);
  const [pageSize, setPageSize] = useState(5);
  const [totalPages, setTotalPages] = useState(0);
  const [sortField, setSortField] = useState<string | null>(null);
  const [sortOrder, setSortOrder] = useState<SortOrder | undefined>(undefined);
  const [modalLoading, setModalLoading] = useState(false);
  const [modalState, setModalState] = useState({
    activeOpen: false,
    activeChecked: false,
    deleteOpen: false,
    isDelete: false,
    userId: null as number | null,
  });

  const fetchUsers = useCallback(
    async (values: any = {}, page: number = 0, size: number = 5, sort: string | null = null) => {
      setLoading(true);
      try {
        // const { searchString, email, name, phone, isActive, userRoles, dateRange } = values;
        const { searchString, isActive, userRoles} = values;
        const dataBody: FilterRequest = {
          searchString: searchString || null,
          isActive: isActive !== undefined ? isActive : null,
          userRoles: userRoles ? [userRoles] : null,
          page,
          size,
          sort,
        };
        const response: FilterResponse = await filterUsersService(dataBody);
        setUsers(response.data.content);
        setTotalPages(response.data.totalPages);
        setCurrentPage(response.data.pageable.pageNumber);
      } catch (error) {
        message.error('Lỗi khi lấy danh sách người dùng.');
      } finally {
        setLoading(false);
      }
    },
    []
  );

  const handleToggleActive = useCallback((userId: number, checked: boolean) => {
    setModalState({
      ...modalState,
      activeOpen: true,
      activeChecked: checked,
      userId,
    });
  }, [modalState]);

  const handleModalActiveOk = async () => {
    if (modalState.userId === null) return;
    setModalLoading(true);
    try {
      const response = await disableUserService({ id: modalState.userId, isActive: modalState.activeChecked });
      if (response.code === 200) {
        message.success(modalState.activeChecked ? 'Kích hoạt người dùng thành công!' : 'Vô hiệu hóa người dùng thành công!');
        setUsers(users.map(user => (user.id === modalState.userId ? { ...user, isActive: modalState.activeChecked } : user)));
      }
    } catch (error) {
      message.error('Lỗi khi cập nhật trạng thái người dùng.');
    } finally {
      setModalLoading(false);
      setModalState({ ...modalState, activeOpen: false, userId: null });
    }
  };

  const handleModalActiveCancel = () => {
    setModalState({ ...modalState, activeOpen: false, userId: null });
  };

  const handleDeleteOrRestore = useCallback((userId: number, isDelete: boolean) => {
    setModalState({
      ...modalState,
      deleteOpen: true,
      isDelete,
      userId,
    });
  }, [modalState]);

  const handleModalDeleteOk = async () => {
    if (modalState.userId === null) return;
    setModalLoading(true);
    try {
      const response = await deleteUserService({
        id: modalState.userId,
        isDelete: modalState.isDelete,
        isActive: false,
      });
      if (response.code === 200) {
        message.success(modalState.isDelete ? 'Xóa người dùng thành công!' : 'Khôi phục người dùng thành công!');
        setUsers(
          users.map(user =>
            user.id === modalState.userId
              ? { ...user, isDelete: modalState.isDelete, isActive: modalState.isDelete ? false : user.isActive }
              : user
          )
        );
      }
    } catch (error) {
      message.error(modalState.isDelete ? 'Lỗi khi xóa người dùng.' : 'Lỗi khi khôi phục người dùng.');
    } finally {
      setModalLoading(false);
      setModalState({ ...modalState, deleteOpen: false, userId: null });
    }
  };

  const handleModalDeleteCancel = () => {
    setModalState({ ...modalState, deleteOpen: false, userId: null });
  };

  const handleTableChange = (pagination: any, _filters: any, sorter: any) => {
    const { field, order } = sorter;
    const newSortField = field || null;
    const newSortOrder = order as SortOrder;
    setSortField(newSortField);
    setSortOrder(newSortOrder);
    setCurrentPage(pagination.current - 1);
    setPageSize(pagination.pageSize);
    fetchUsers(
      form.getFieldsValue(),
      pagination.current - 1,
      pagination.pageSize,
      newSortField && newSortOrder ? `${newSortField},${newSortOrder === 'ascend' ? 'asc' : 'desc'}` : null
    );
  };

  const columns = [
    {
      title: 'Họ và tên',
      key: 'name',
      width: 150,
      render: (record: User) => `${record.firstName} ${record.lastName}`,
      // ellipsis: true,
      // sorter: true,
      // sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
      // sortOrder: sortField === 'name' ? sortOrder : undefined,
    },
    // {
    //   title: 'Email',
    //   dataIndex: 'email',
    //   key: 'email',
    //   width: 200,
    //   sorter: true,
    //   sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
    //   sortOrder: sortField === 'email' ? sortOrder : undefined,
    // },
    {
      title: 'Số điện thoại',
      dataIndex: 'phone',
      key: 'phone',
      width: 150,
    },
    // {
    //   title: 'Ngày sinh',
    //   dataIndex: 'dob',
    //   key: 'dob',
    //   width: 150,
    //   render: (dob: string) => (dob ? moment(dob).format('DD/MM/YYYY') : 'Chưa xác định'),
    //   sorter: true,
    //   sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
    //   sortOrder: sortField === 'dob' ? sortOrder : undefined,
    // },
    {
      title: 'Vai trò',
      dataIndex: 'role',
      key: 'role',
      width: 100,
      render: (role: string) => role || 'Chưa xác định',
    },
    {
      title: 'Ngày tạo',
      dataIndex: 'createdAt',
      key: 'createdAt',
      width: 150,
      render: (dob: string) => (dob ? moment(dob).format('DD/MM/YYYY') : 'Chưa xác định'),
      sorter: true,
      sortDirections: ['ascend', 'descend'] as ('ascend' | 'descend')[],
      sortOrder: sortField === 'createdAt' ? sortOrder : undefined,
    },
    {
      title: 'Trạng thái',
      dataIndex: 'isActive',
      key: 'isActive',
      width: 100,
      render: (isActive: boolean, record: User) => (
        <Switch
          checked={isActive}
          onChange={(checked) => handleToggleActive(record.id, checked)}
          disabled={record.isDelete}
          aria-label={`Bật/tắt trạng thái cho người dùng ${record.firstName} ${record.lastName}`}
        />
      ),
    },
    {
      title: 'Hành động',
      key: 'action',
      width: 150,
      render: (_: any, record: User) => (
        <div className="action-buttons">
          {record.isDelete ? (
            <Button size="small" onClick={() => handleDeleteOrRestore(record.id, false)}>
              Khôi phục
            </Button>
          ) : (
            <Button
              danger
              size="small"
              onClick={() => handleDeleteOrRestore(record.id, true)}
            >
              Xóa
            </Button>
          )}
        </div>
      ),
    },
  ];

  useEffect(() => {
    fetchUsers();
  }, []);

  return (
    <div className="member-management">
      <h2>Quản Lý Thành Viên</h2>
      <Form
        form={form}
        layout="inline"
        onFinish={(values) =>
          fetchUsers(
            values,
            0,
            pageSize,
            sortField && sortOrder ? `${sortField},${sortOrder === 'ascend' ? 'asc' : 'desc'}` : null
          )
        }
        style={{ marginBottom: 16 }}
        className="search-form"
      >
        <Form.Item name="searchString" label="Tìm kiếm">
          <Input placeholder="Nhập email, tên hoặc số điện thoại" />
        </Form.Item>
        <Form.Item name="userRoles" label="Vai trò">
          <Select placeholder="Chọn vai trò" allowClear>
            <Option value="MANAGER">Quản lý</Option>
            <Option value="CONSULTANT">Nhân viên</Option>
            <Option value="STUDENT">Học Sinh</Option>
            <Option value="TEACHER">Giáo viên</Option>
          </Select>
        </Form.Item>
        <Form.Item name="isActive" label="Trạng thái">
          <Select placeholder="Chọn trạng thái" allowClear>
            <Option value={true}>Kích hoạt</Option>
            <Option value={false}>Vô hiệu hóa</Option>
          </Select>
        </Form.Item>
        <Form.Item name="dateRange" label="Ngày tạo">
          <RangePicker format="DD/MM/YYYY" />
        </Form.Item>
        <div className="form-actions">
          <Form.Item>
            <Button type="primary" htmlType="submit" onClick={() => setCurrentPage(0)}>
              Tìm kiếm
            </Button>
          </Form.Item>
          <Form.Item>
            <Button onClick={() => { form.resetFields(); setSortField(null); setSortOrder(undefined); fetchUsers({}, 0, pageSize, null); }}>
              Xóa bộ lọc
            </Button>
          </Form.Item>
        </div>
      </Form>
      <Table
        columns={columns}
        dataSource={users}
        loading={loading}
        pagination={{
          current: currentPage + 1,
          pageSize: pageSize,
          total: totalPages * pageSize,
          showSizeChanger: true,
          pageSizeOptions: ['5','10', '20', '50'],
        }}
        onChange={handleTableChange}
      />
      <Modal
        title={modalState.activeChecked ? 'Xác nhận kích hoạt người dùng' : 'Xác nhận vô hiệu hóa người dùng'}
        open={modalState.activeOpen}
        onOk={handleModalActiveOk}
        onCancel={handleModalActiveCancel}
        okText="Xác nhận"
        cancelText="Hủy"
        confirmLoading={modalLoading}
      >
        <p>
          {modalState.activeChecked
            ? 'Bạn có chắc chắn muốn kích hoạt người dùng này?'
            : 'Bạn có chắc chắn muốn vô hiệu hóa người dùng này?'}
        </p>
      </Modal>
      <Modal
        title={modalState.isDelete ? 'Xác nhận xóa người dùng' : 'Xác nhận khôi phục người dùng'}
        open={modalState.deleteOpen}
        onOk={handleModalDeleteOk}
        onCancel={handleModalDeleteCancel}
        okText="Xác nhận"
        cancelText="Hủy"
        okType={modalState.isDelete ? 'danger' : 'primary'}
        confirmLoading={modalLoading}
      >
        <p>
          {modalState.isDelete
            ? 'Bạn có chắc chắn muốn xóa người dùng này? Hành động này không thể hoàn tác.'
            : 'Bạn có chắc chắn muốn khôi phục người dùng này?'}
        </p>
      </Modal>
    </div>
  );
};

export default MemberManagement;.member-management {
  margin-left: 270px;
  padding: 20px;
  min-height: calc(100vh - 64px);
  background: #f5f7fa;
}

.member-management h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 20px;
  color: #1890ff;
}

.member-management .ant-form {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.member-management .ant-form-item {
  margin-bottom: 0;
}

.member-management .ant-input,
.member-management .ant-select,
.member-management .ant-picker {
  width: 180px;
}

.member-management .ant-table {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.member-management .ant-table-thead > tr > th {
  background: #fafafa;
  font-weight: 600;
}

.status-active {
  color: #52c41a;
  font-weight: 500;
}

.status-inactive {
  color: #fa8c16;
  font-weight: 500;
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.action-buttons .ant-btn {
  height: 32px;
  font-size: 14px;
}

.deleted-user {
  text-decoration: line-through;
}

.form-actions {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
  align-items: center;
}

@media (max-width: 768px) {
  .member-management {
    margin-left: 0;
    padding: 16px;
  }

  .member-management .ant-form {
    flex-direction: column;
  }

  .member-management .ant-input,
  .member-management .ant-select,
  .member-management .ant-picker {
    width: 100%;
  }

  .form-actions {
    flex-direction: column;
    gap: 12px;
    width: 100%;
  }

  .form-actions .ant-btn {
    width: 100%;
  }
}import { useState, useEffect } from 'react';
import { Form, Input, Select, Button, Upload, message, Image, Card, Space } from 'antd';
import { UploadOutlined, EyeOutlined, SaveOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import TipTapEditor from 'components/common/TipTapEditor/TipTapEditor';
import { createPostService, uploadImageService, getCategoriesService } from '../../../services/blogService';
import type { Category } from '../../../types/blog';
import './WriteBlog.css';

const { Option } = Select;

interface BlogFormValues {
  title: string;
  themeUrl: string;
  categoryId: number;
}

const WriteBlog = () => {
  const [form] = Form.useForm();
  const navigate = useNavigate();
  const [content, setContent] = useState('');
  const [loading, setLoading] = useState(false);
  const [uploadLoading, setUploadLoading] = useState(false);
  const [themeUrl, setThemeUrl] = useState<string>('');
  const [categories, setCategories] = useState<Category[]>([]);
  const [loadingCategories, setLoadingCategories] = useState(true);
  const [isDraft, setIsDraft] = useState(false);

  // Load categories on component mount
  useEffect(() => {
    const loadCategories = async () => {
      try {
        setLoadingCategories(true);
        const response = await getCategoriesService();
        if (response.data) {
          setCategories(response.data);
        }
      } catch (error) {
        console.error('Failed to load categories:', error);
        message.error('Không thể tải danh mục');
        // Fallback categories
        setCategories([
          { id: 1, name: 'TIPS' },
          { id: 2, name: 'Giáo dục' },
          { id: 3, name: 'Lập trình' },
        ]);
      } finally {
        setLoadingCategories(false);
      }
    };

    loadCategories();
  }, []);

  // Auto-save draft functionality
  useEffect(() => {
    const saveDraft = () => {
      const formValues = form.getFieldsValue();
      const draftData = {
        ...formValues,
        content,
        themeUrl,
        timestamp: Date.now(),
      };
      localStorage.setItem('blog_draft', JSON.stringify(draftData));
    };

    // Save draft every 30 seconds if there's content
    const interval = setInterval(() => {
      if (content || form.getFieldValue('title')) {
        saveDraft();
        setIsDraft(true);
      }
    }, 30000);

    return () => clearInterval(interval);
  }, [content, form, themeUrl]);

  // Load draft on component mount
  useEffect(() => {
    const loadDraft = () => {
      const savedDraft = localStorage.getItem('blog_draft');
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          // Only load draft if it's less than 24 hours old
          if (Date.now() - draftData.timestamp < 24 * 60 * 60 * 1000) {
            form.setFieldsValue({
              title: draftData.title || '',
              categoryId: draftData.categoryId || 1,
              themeUrl: draftData.themeUrl || '',
            });
            setContent(draftData.content || '');
            setThemeUrl(draftData.themeUrl || '');
            setIsDraft(true);
          }
        } catch (error) {
          console.error('Failed to load draft:', error);
        }
      }
    };

    loadDraft();
  }, [form]);

  const validateContent = () => {
    if (!content || content.trim() === '' || content === '<p></p>') {
      return false;
    }
    // Check if content has meaningful text (not just HTML tags)
    const textContent = content.replace(/<[^>]*>/g, '').trim();
    return textContent.length > 10;
  };

  const resetForm = () => {
    // Clear draft
    localStorage.removeItem('blog_draft');
    // Reset form
    form.resetFields();
    // Reset states
    setContent('');
    setThemeUrl('');
    setIsDraft(false);
    // Reset form values to initial state
    form.setFieldsValue({
      title: '',
      themeUrl: '',
      categoryId: categories.length > 0 ? categories[0].id : 1,
    });
  };

  const handleSubmit = async (values: BlogFormValues) => {
    if (!validateContent()) {
      message.error('Vui lòng nhập nội dung bài viết (ít nhất 10 ký tự)');
      return;
    }

    setLoading(true);
    try {
      const postData = {
        title: values.title,
        content,
        themeUrl: values.themeUrl,
        categoryId: values.categoryId,
      };
      
      const response = await createPostService(postData);
      if (response.code === 200) {
        message.success('Đăng bài thành công! Bạn có thể tiếp tục viết bài mới.');
        // Reset form to initial state
        resetForm();
      }
    } catch (error) {
      console.error('Submit error:', error);
      message.error('Đăng bài thất bại. Vui lòng thử lại.');
    } finally {
      setLoading(false);
    }
  };

  const handleUploadTheme = async (file: File) => {
    // Validate file
    if (!file.type.startsWith('image/')) {
      message.error('Vui lòng chọn file ảnh');
      return false;
    }
    
    if (file.size > 5 * 1024 * 1024) {
      message.error('Kích thước ảnh không được vượt quá 5MB');
      return false;
    }

    setUploadLoading(true);
    try {
      const formData = new FormData();
      formData.append('file', file);
      const response = await uploadImageService(formData);
      if (response.code === 200) {
        const url = response.data;
        form.setFieldsValue({ themeUrl: url });
        setThemeUrl(url);
        message.success('Tải ảnh đại diện thành công!');
      }
    } catch (error: any) {
      console.error('Upload error:', error);
      message.error('Lỗi khi tải ảnh đại diện.');
    } finally {
      setUploadLoading(false);
    }
    return false;
  };

  const handleRemoveTheme = () => {
    form.setFieldsValue({ themeUrl: '' });
    setThemeUrl('');
  };

  const handleSaveDraft = () => {
    const formValues = form.getFieldsValue();
    const draftData = {
      ...formValues,
      content,
      themeUrl,
      timestamp: Date.now(),
    };
    localStorage.setItem('blog_draft', JSON.stringify(draftData));
    setIsDraft(true);
    message.success('Đã lưu bản nháp');
  };

  const handleCancel = () => {
    const hasUnsavedChanges = content || form.getFieldValue('title') || themeUrl;
    
    if (hasUnsavedChanges) {
      const confirmed = window.confirm('Bạn có muốn lưu bản nháp trước khi thoát không?');
      if (confirmed) {
        handleSaveDraft();
        return;
      }
    }
    
    // Navigate back to dashboard
    navigate('/dashboard');
  };

  const handleNewPost = () => {
    const hasUnsavedChanges = content || form.getFieldValue('title') || themeUrl;
    
    if (hasUnsavedChanges) {
      const confirmed = window.confirm('Bạn có muốn lưu bản nháp trước khi tạo bài mới không?');
      if (confirmed) {
        handleSaveDraft();
      }
    }
    
    resetForm();
    message.success('Đã tạo bài viết mới');
  };

  const handleClearDraft = () => {
    localStorage.removeItem('blog_draft');
    resetForm();
    message.success('Đã xóa bản nháp');
  };

  const getWordCount = () => {
    const textContent = content.replace(/<[^>]*>/g, '').trim();
    const words = textContent.split(/\s+/).filter(word => word.length > 0);
    return {
      characters: textContent.length,
      words: words.length
    };
  };

  const wordCount = getWordCount();

  return (
    <div className="write-blog">
      <div className="write-blog-header">
        <h2>Viết Blog</h2>
        <div className="header-actions">
          {isDraft && (
            <div className="draft-indicator">
              <span className="draft-badge">Bản nháp đã lưu</span>
              <Button size="small" onClick={handleClearDraft}>
                Xóa bản nháp
              </Button>
            </div>
          )}
          <Button 
            type="default" 
            onClick={handleNewPost}
            disabled={loading}
          >
            📝 Bài mới
          </Button>
        </div>
      </div>

      <Card className="write-blog-card">
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSubmit}
          initialValues={{ categoryId: 1 }}
        >
          <Form.Item
            name="title"
            label="Tiêu đề"
            rules={[
              { required: true, message: 'Vui lòng nhập tiêu đề!' },
              { min: 10, message: 'Tiêu đề phải có ít nhất 10 ký tự!' },
              { max: 200, message: 'Tiêu đề không được vượt quá 200 ký tự!' }
            ]}
          >
            <Input 
              placeholder="Nhập tiêu đề bài viết" 
              showCount 
              maxLength={200}
            />
          </Form.Item>

          <Form.Item
            name="themeUrl"
            label="Ảnh đại diện"
            rules={[{ required: true, message: 'Vui lòng tải ảnh đại diện!' }]}
          >
            <div className="theme-upload-container">
              <Upload
                accept="image/*"
                showUploadList={false}
                beforeUpload={handleUploadTheme}
                disabled={uploadLoading}
              >
                <Button 
                  icon={<UploadOutlined />} 
                  loading={uploadLoading}
                  disabled={!!themeUrl}
                >
                  {uploadLoading ? 'Đang tải...' : 'Tải ảnh đại diện'}
                </Button>
              </Upload>
              
              {themeUrl && (
                <div className="theme-preview">
                  <Image 
                    src={themeUrl} 
                    alt="Ảnh đại diện" 
                    width={200}
                    preview={{
                      mask: <EyeOutlined />,
                    }}
                  />
                  <Button 
                    onClick={handleRemoveTheme} 
                    style={{ marginTop: 8 }}
                    danger
                  >
                    Xóa ảnh
                  </Button>
                </div>
              )}
            </div>
          </Form.Item>

          <Form.Item
            name="categoryId"
            label="Chuyên mục"
            rules={[{ required: true, message: 'Vui lòng chọn chuyên mục!' }]}
          >
            <Select 
              placeholder="Chọn chuyên mục" 
              loading={loadingCategories}
            >
              {categories.map(category => (
                <Option key={category.id} value={category.id}>
                  {category.name}
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            label="Nội dung"
            name="content"
            rules={[
              {
                validator: () => {
                  if (!validateContent()) {
                    return Promise.reject(new Error('Vui lòng nhập nội dung bài viết (ít nhất 10 ký tự)!'));
                  }
                  return Promise.resolve();
                },
              },
            ]}
          >
            <TipTapEditor 
              content={content} 
              onChange={setContent}
              placeholder="Bắt đầu viết nội dung bài blog của bạn..."
            />
          </Form.Item>

          <div className="content-stats">
            <span>
              📝 {wordCount.words} từ, {wordCount.characters} ký tự
            </span>
            <span className={wordCount.characters < 100 ? 'warning' : 'success'}>
              {wordCount.characters < 100 ? '⚠️ Nội dung còn quá ngắn' : '✅ Độ dài phù hợp'}
            </span>
          </div>

          <Form.Item>
            <div className="button-group">
              <Space>
                <Button 
                  type="primary" 
                  htmlType="submit" 
                  loading={loading}
                  disabled={!validateContent()}
                >
                  Đăng bài
                </Button>
                <Button 
                  type="default" 
                  onClick={handleSaveDraft}
                  icon={<SaveOutlined />}
                  disabled={loading}
                >
                  Lưu nháp
                </Button>
                <Button 
                  type="default" 
                  onClick={handleCancel}
                  disabled={loading}
                >
                  Hủy
                </Button>
              </Space>
            </div>
          </Form.Item>
        </Form>
      </Card>
    </div>
  );
};

export default WriteBlog;.write-blog {
  margin-left: 270px;
  padding: 24px;
  min-height: calc(100vh - 64px);
  background: #f5f7fa;
}

.write-blog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.write-blog-header h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 0;
  color: #1890ff;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.draft-indicator {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
}

.draft-badge {
  font-size: 13px;
  font-weight: 500;
  color: #856404;
}

.write-blog-card {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  border: none;
  overflow: hidden;
}

.write-blog-card .ant-card-body {
  padding: 32px;
}

/* Form Styling */
.write-blog .ant-form-item {
  margin-bottom: 24px;
}

.write-blog .ant-form-item-label > label {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

.write-blog .ant-input,
.write-blog .ant-select-selector {
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 15px;
}

.write-blog .ant-input-affix-wrapper {
  border-radius: 8px;
  padding: 8px 16px;
}

/* Theme Upload Container */
.theme-upload-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.theme-preview {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
  border: 2px dashed #e2e8f0;
  margin-top: 10px;
}

.theme-preview .ant-image {
  border-radius: 8px;
  overflow: hidden;
  display: block;
}

/* Content Stats */
.content-stats {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f8fafc;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  font-weight: 500;
}

.content-stats .warning {
  color: #d69e2e;
}

.content-stats .success {
  color: #38a169;
}

/* Button Styling */
.write-blog .ant-btn {
  height: 44px;
  padding: 0 24px;
  font-size: 15px;
  font-weight: 500;
  border-radius: 8px;
}

.button-group {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e2e8f0;
}

/* Form Validation Styling */
.write-blog .ant-form-item-explain-error {
  font-size: 13px;
  margin-top: 4px;
}

/* Select Dropdown */
.write-blog .ant-select-dropdown {
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.write-blog .ant-select-item {
  padding: 12px 16px;
  font-size: 14px;
}

/* Responsive Design */
@media (max-width: 1200px) {
  .write-blog {
    margin-left: 0;
    padding: 16px;
  }
  
  .write-blog-card .ant-card-body {
    padding: 24px;
  }
}

@media (max-width: 768px) {
  .write-blog {
    padding: 12px;
  }
  
  .write-blog-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .write-blog-header h2 {
    font-size: 24px;
  }

  .header-actions {
    width: 100%;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  
  .draft-indicator {
    flex: 1;
    min-width: 200px;
  }
  
  .write-blog-card .ant-card-body {
    padding: 20px;
  }
  
  .button-group {
    flex-direction: column;
    gap: 8px;
  }
  
  .button-group .ant-btn {
    width: 100%;
    margin-bottom: 8px;
  }
  
  .content-stats {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .theme-preview {
    padding: 12px;
  }

  .theme-preview .ant-image {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .write-blog {
    padding: 8px;
  }
  
  .write-blog-card .ant-card-body {
    padding: 16px;
  }
  
  .write-blog-header {
    gap: 8px;
  }

  .header-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .draft-indicator {
    flex: none;
    width: 100%;
  }
}
import './Dashboard.css';
import { Outlet} from 'react-router-dom';
import Navigation from 'components/common/Dashboard/Navigation/Navigation';

const Dashboard = () => {
  return (
    <div className='dashboard'>
      <Navigation />
      <Outlet />
    </div>
  );
};

export default Dashboard;
.dashboard{
  display: flex;
}import axios from 'axios';
import useAuthStore from '../store/authStore';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8080',
  headers: {
    'Content-Type': 'application/json',
  },
});

// Interceptor để thêm token vào header
api.interceptors.request.use((config) => {
  const token = useAuthStore.getState().token;
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Interceptor để xử lý lỗi (ví dụ: token hết hạn)
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      try {
        const { data } = await api.get('/api/v1/auth/refresh');
        const newToken = data.data.token;
        useAuthStore.getState().setToken(newToken);
        originalRequest.headers.Authorization = `Bearer ${newToken}`;
        return api(originalRequest);
      } catch (refreshError) {
        useAuthStore.getState().logout();
        return Promise.reject(refreshError);
      }
    }
    return Promise.reject(error);
  },
);

export default api;// constants/permissions.ts - Updated with Cart & Order Permissions

/**
 * ✅ ROLE PERMISSIONS
 * 
 * Định nghĩa các tabs/pages mà mỗi role được access
 */
export const rolePermissions: { [key: string]: string[] } = {
  student: [
    'profile',           // Thông tin cá nhân
    'video-courses',     // Khóa học video đã mua
    'offline-classes',   // Lớp học offline
    'cart',              // ✅ NEW: Quản lý giỏ hàng
    'orders',            // ✅ NEW: Lịch sử đơn hàng
    'courses-browse'     // ✅ NEW: Duyệt khóa học để mua (public page)
  ],
  teacher: [
    'profile', 
    'class-management', 
    'question-bank'
  ],
  manager: [
    'profile', 
    'statistics', 
    'member-management', 
    'course-management', 
    'blog-approval', 
    'question-bank', 
    'business',
    'order-management'   // ✅ NEW: Quản lý đơn hàng (admin view)
  ],
  consultant: [
    'profile', 
    'write-blog', 
    'course-management', 
    'business'
  ],
};

/**
 * ✅ NAVIGATION PERMISSIONS
 * 
 * Định nghĩa menu items nào hiển thị cho role nào
 */
export const navigationPermissions = {
  // ============= MAIN NAVIGATION (Header Menu) =============
  courses: ['student', 'teacher', 'manager', 'consultant'],
  blog: ['student', 'teacher', 'manager', 'consultant'],
  test: ['student', 'teacher', 'manager', 'consultant'],
  
  // ============= DASHBOARD NAVIGATION (Sidebar Menu) =============
  profile: ['student', 'teacher', 'manager', 'consultant'],
  
  // Student specific
  'video-courses': ['student'],
  'offline-classes': ['student'],
  'cart': ['student'],                    // ✅ NEW: Giỏ hàng
  'orders': ['student'],                  // ✅ NEW: Đơn hàng của student
  
  // Teacher specific  
  'class-management': ['teacher'],
  
  // Shared between teacher & manager
  'question-bank': ['teacher', 'manager'],
  
  // Manager specific
  'statistics': ['manager'],
  'blog-approval': ['manager'],
  'order-management': ['manager'],        // ✅ NEW: Quản lý đơn hàng (admin)
  
  // Shared between manager & consultant
  'course-management': ['manager', 'consultant'],
  'business': ['manager', 'consultant'],
  
  // Manager & Student (special case)
  'member-management': ['manager', 'student'],
  
  // Consultant specific
  'write-blog': ['consultant'],
} as const;

/**
 * ✅ HELPER FUNCTIONS
 */

// Check xem user có permission cho tab này không
export const hasPermission = (userRole: string, tabName: string): boolean => {
  return rolePermissions[userRole]?.includes(tabName) || false;
};

// Check xem tab có hiển thị trong navigation không
export const showInNavigation = (userRole: string, tabName: string): boolean => {
  const allowedRoles = navigationPermissions[tabName as keyof typeof navigationPermissions] as readonly string[] | undefined;
  return allowedRoles?.includes(userRole) || false;
};

// Get tất cả tabs được phép cho 1 role
export const getAllowedTabs = (userRole: string): string[] => {
  return rolePermissions[userRole] || [];
};// components/Dashboard/Navigation/Navigation.tsx - Updated with Orders
import { Menu } from 'antd';
import { 
  UserOutlined, 
  VideoCameraOutlined, 
  TeamOutlined, 
  BarChartOutlined, 
  BookOutlined, 
  SolutionOutlined, 
  FileTextOutlined, 
  DollarOutlined,
  ShoppingCartOutlined,     // ✅ Cart icon
  ShoppingOutlined         // ✅ Orders icon
} from '@ant-design/icons';
import useAuthStore from 'store/authStore';
import { useState } from 'react';
import { Link, useLocation } from 'react-router-dom';
import './Navigation.css';

const Navigation = () => {
  const { user } = useAuthStore();
  const location = useLocation();
  const [selectedKey, setSelectedKey] = useState(location.pathname.split('/')[2] || 'profile');

  // ✅ UPDATED: Student items với Cart và Orders
  const studentItems = [
    { key: 'profile', icon: <UserOutlined />, label: 'Thông tin cá nhân' },
    { key: 'video-courses', icon: <VideoCameraOutlined />, label: 'Khóa học video' },
    { key: 'offline-classes', icon: <TeamOutlined />, label: 'Lớp học offline' },
    { key: 'cart', icon: <ShoppingCartOutlined />, label: 'Giỏ hàng' },           // ✅ Phase 1
    { key: 'orders', icon: <ShoppingOutlined />, label: 'Lịch sử đơn hàng' },     // ✅ Phase 2 - NEW
    { key: 'member-management', icon: <SolutionOutlined />, label: 'Quản lý thành viên' },
  ];

  const teacherItems = [
    { key: 'profile', icon: <UserOutlined />, label: 'Thông tin cá nhân' },
    { key: 'class-management', icon: <TeamOutlined />, label: 'Quản lý lớp học' },
    { key: 'question-bank', icon: <BookOutlined />, label: 'Ngân hàng đề' },
  ];

  const managerItems = [
    { key: 'profile', icon: <UserOutlined />, label: 'Thông tin cá nhân' },
    { key: 'statistics', icon: <BarChartOutlined />, label: 'Xem thống kê' },
    { key: 'member-management', icon: <SolutionOutlined />, label: 'Quản lý thành viên' },
    { key: 'course-management', icon: <BookOutlined />, label: 'Quản lý khóa học' },
    { key: 'blog-approval', icon: <FileTextOutlined />, label: 'Duyệt blog' },
    { key: 'question-bank', icon: <BookOutlined />, label: 'Ngân hàng đề' },
    { key: 'business', icon: <DollarOutlined />, label: 'Kinh doanh' },
  ];

  const consultantItems = [
    { key: 'profile', icon: <UserOutlined />, label: 'Thông tin cá nhân' },
    { key: 'write-blog', icon: <FileTextOutlined />, label: 'Viết blog' },
    { key: 'course-management', icon: <BookOutlined />, label: 'Quản lý khóa học' },
    { key: 'business', icon: <DollarOutlined />, label: 'Kinh doanh' },
  ];

  const items = (() => {
    switch (user?.role) {
      case 'manager':
        return managerItems;
      case 'consultant':
        return consultantItems;
      case 'teacher':
        return teacherItems;
      default:
        return studentItems;  // ✅ Student có đầy đủ Cart + Orders
    }
  })();

  return (
    <div className="profile-sidebar">
      <div className="avatar-section">
        <img src="https://mcdn.coolmate.me/image/March2023/meme-meo-cute-hai-huoc-1297_521.jpg" alt="" className="avatar-img" />
        <h3>
          {user?.role === 'teacher' ? 'Giáo viên' : 
           user?.role === 'manager' ? 'Quản lý' : 
           user?.role === 'consultant' ? 'Tư vấn viên' : 'Học sinh'}: 
          {` ${user?.firstName} ${user?.lastName}` || 'User'}
        </h3>
      </div>
      <Menu
        selectedKeys={[selectedKey]}
        onSelect={({ key }) => setSelectedKey(key)}
        items={items.map(item => ({
          key: item.key,
          icon: item.icon,
          label: <Link to={`/dashboard/${item.key}`}>{item.label}</Link>,
        }))}
      />
    </div>
  );
};

export default Navigation;.profile-sidebar {
  width: 250px;
  background: #fff;
  padding: 20px;
  border-right: 1px solid #e8e8e8;
  height: calc(100vh - 64px);
  position: fixed;
  top: 64px;
}

.profile-sidebar .avatar-section {
  text-align: center;
  margin-bottom: 20px;
}

.profile-sidebar .avatar-img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
}

.avatar-section h3 {
  margin: 10px 0;
  font-size: 16px;
  color: #1890ff;
}

.ant-menu-item {
  margin: 8px 0;
  font-size: 14px;
}

.ant-menu-item-selected {
  background-color: #e6f7ff;
}// components/CourseManagement/CourseDetailDrawer/CourseDetailDrawer.tsx - Final
import { Drawer, Form, Input, Button, Select, InputNumber, Upload, message, Descriptions, Divider, Image, Typography } from 'antd';
import { useState, useEffect } from 'react';
import { UploadOutlined, EyeOutlined, EditOutlined, PlusOutlined } from '@ant-design/icons';
import { getCourseByIdService, createCourseService, updateCourseInfoService, uploadImageService, getTeachersService } from '../../../../services/courseManagementService';
import type { Course, Category, CourseCreateRequest, CourseUpdateRequest } from '../../../../types/course';
import type { User } from '../../../../types/user';
import moment from 'moment';

const { Option } = Select;
const { Title, Text } = Typography;

interface CourseDetailDrawerProps {
  open: boolean;
  onClose: () => void;
  course: Course | null;
  categories: Category[];
  onCourseUpdated: () => void;
}

const CourseDetailDrawer = ({ open, onClose, course, categories, onCourseUpdated }: CourseDetailDrawerProps) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [uploadLoading, setUploadLoading] = useState(false);
  const [fileList, setFileList] = useState<any[]>([]);
  const [thumbnailUrl, setThumbnailUrl] = useState<string | null>(null);
  const [isEditing, setIsEditing] = useState(false);
  const [courseDetails, setCourseDetails] = useState<Course | null>(null);
  const [teachers, setTeachers] = useState<User[]>([]); // ✅ Thêm state cho teachers

  const isCreateMode = !course;
  const isViewMode = course && !isEditing;

  // ✅ Thêm function để fetch teachers
  const fetchTeachers = async () => {
    try {
      const teacherList = await getTeachersService();
      setTeachers(teacherList);
    } catch (error) {
      console.error('Lỗi khi lấy danh sách giáo viên:', error);
    }
  };

  useEffect(() => {
    // ✅ Fetch teachers khi component mount
    fetchTeachers();
    
    if (course) {
      fetchCourseDetails(course.id);
      setIsEditing(false);
    } else {
      // Create mode
      form.resetFields();
      setThumbnailUrl(null);
      setFileList([]);
      setCourseDetails(null);
      setIsEditing(true);
    }
  }, [course, form]);

  const fetchCourseDetails = async (courseId: number) => {
    try {
      setLoading(true);
      const response = await getCourseByIdService(courseId);
      if (response.code === 200) {
        const courseData = response.data;
        setCourseDetails(courseData);
        
        // ✅ Map categoryName to categoryId để set form
        const categoryId = categories.find(cat => cat.name === courseData.categoryName)?.id;
        // ✅ Find authorId từ author object
        const authorId = courseData.author?.id;
        
        form.setFieldsValue({
          title: courseData.title,
          description: courseData.description,
          price: courseData.price,
          categoryId: categoryId,
          authorId: authorId, // ✅ Set authorId cho edit mode
        });
        
        setThumbnailUrl(courseData.thumbnailUrl);
        setFileList(courseData.thumbnailUrl ? [{ 
          uid: '-1', 
          name: 'thumbnail.jpg', 
          url: courseData.thumbnailUrl, 
          status: 'done' 
        }] : []);
      }
    } catch (error) {
      console.error('Lỗi khi lấy chi tiết khóa học:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleUpload = async ({ file }: any) => {
    if (!file) return;
    
    const isImage = file.type.startsWith('image/');
    if (!isImage) {
      message.error('Vui lòng chọn file hình ảnh!');
      return;
    }
    
    const isLt5M = file.size / 1024 / 1024 < 5;
    if (!isLt5M) {
      message.error('Kích thước file phải nhỏ hơn 5MB!');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);
    
    try {
      setUploadLoading(true);
      const response = await uploadImageService(formData);
      if (response.code === 200) {
        setThumbnailUrl(response.data);
        setFileList([{ 
          uid: file.uid, 
          name: file.name, 
          url: response.data, 
          status: 'done' 
        }]);
        message.success('Tải ảnh lên thành công!');
      }
    } catch (error) {
      console.error('Lỗi khi tải ảnh lên:', error);
      setFileList([]);
      setThumbnailUrl(null);
    } finally {
      setUploadLoading(false);
    }
  };

  const handleRemoveFile = () => {
    setFileList([]);
    setThumbnailUrl(null);
  };

  const onFinish = async (values: any) => {
    // ✅ Validate authorId cho cả create và update
    if (!values.authorId) {
      message.error('Vui lòng chọn giáo viên!');
      return;
    }

    setLoading(true);
    try {
      if (course) {
        // Update existing course
        const updateData: CourseUpdateRequest = {
          id: course.id,
          title: values.title,
          description: values.description,
          price: values.price,
          categoryId: values.categoryId,
          thumbnailUrl: thumbnailUrl || course.thumbnailUrl || '',
        };
        
        const response = await updateCourseInfoService(updateData);
        if (response.code === 200) {
          message.success('Cập nhật khóa học thành công!');
          onCourseUpdated();
          setIsEditing(false);
          // Refresh course details
          await fetchCourseDetails(course.id);
        }
      } else {
        // Create new course
        const createData: CourseCreateRequest = {
          title: values.title,
          description: values.description || '',
          price: values.price,
          authorId: values.authorId, // ✅ Sử dụng authorId từ form
          categoryId: values.categoryId,
          thumbnailUrl: thumbnailUrl || '',
          isActive: false,
          isDelete: false,
        };
        
        const response = await createCourseService(createData);
        if (response.code === 200) {
          message.success('Tạo khóa học thành công!');
          onCourseUpdated();
          onClose();
        }
      }
    } catch (error) {
      console.error(course ? 'Lỗi khi cập nhật khóa học:' : 'Lỗi khi tạo khóa học:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleClose = () => {
    form.resetFields();
    setThumbnailUrl(null);
    setFileList([]);
    setIsEditing(false);
    setCourseDetails(null);
    onClose();
  };

  const handleEdit = () => {
    setIsEditing(true);
  };

  const handleCancelEdit = () => {
    setIsEditing(false);
    // Reset form to original values
    if (courseDetails) {
      const categoryId = categories.find(cat => cat.name === courseDetails.categoryName)?.id;
      const authorId = courseDetails.author?.id;
      form.setFieldsValue({
        title: courseDetails.title,
        description: courseDetails.description,
        price: courseDetails.price,
        categoryId: categoryId,
        authorId: authorId, // ✅ Reset authorId
      });
      setThumbnailUrl(courseDetails.thumbnailUrl);
      setFileList(courseDetails.thumbnailUrl ? [{ 
        uid: '-1', 
        name: 'thumbnail.jpg', 
        url: courseDetails.thumbnailUrl, 
        status: 'done' 
      }] : []);
    }
  };

  const getTitle = () => {
    if (isCreateMode) return 'Tạo khóa học mới';
    if (isViewMode) return 'Chi tiết khóa học';
    return 'Chỉnh sửa khóa học';
  };

  const getFooterButtons = () => {
    if (isCreateMode) {
      return (
        <div style={{ textAlign: 'right' }}>
          <Button onClick={handleClose} style={{ marginRight: 8 }}>
            Hủy
          </Button>
          <Button type="primary" loading={loading} onClick={() => form.submit()}>
            Tạo mới
          </Button>
        </div>
      );
    }

    if (isViewMode) {
      return (
        <div style={{ textAlign: 'right' }}>
          <Button onClick={handleClose} style={{ marginRight: 8 }}>
            Đóng
          </Button>
          <Button type="primary" icon={<EditOutlined />} onClick={handleEdit}>
            Chỉnh sửa
          </Button>
        </div>
      );
    }

    return (
      <div style={{ textAlign: 'right' }}>
        <Button onClick={handleCancelEdit} style={{ marginRight: 8 }}>
          Hủy
        </Button>
        <Button type="primary" loading={loading} onClick={() => form.submit()}>
          Cập nhật
        </Button>
      </div>
    );
  };

  return (
    <Drawer
      title={
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          {isCreateMode ? <PlusOutlined /> : isViewMode ? <EyeOutlined /> : <EditOutlined />}
          {getTitle()}
        </div>
      }
      width={600}
      open={open}
      onClose={handleClose}
      destroyOnClose
      footer={getFooterButtons()}
    >
      {/* ✅ View Mode - Course Details */}
      {isViewMode && courseDetails && (
        <div>
          <Descriptions column={1} bordered size="small">
            <Descriptions.Item label="ID">{courseDetails.id}</Descriptions.Item>
            <Descriptions.Item label="Tiêu đề">{courseDetails.title}</Descriptions.Item>
            <Descriptions.Item label="Mô tả">
              {courseDetails.description || 'Chưa có mô tả'}
            </Descriptions.Item>
            <Descriptions.Item label="Giá">
              <Text strong style={{ color: '#1890ff', fontSize: '16px' }}>
                {new Intl.NumberFormat('vi-VN', { 
                  style: 'currency', 
                  currency: 'VND' 
                }).format(courseDetails.price)}
              </Text>
            </Descriptions.Item>
            <Descriptions.Item label="Chủ đề">
              {courseDetails.categoryName || 'Chưa xác định'}
            </Descriptions.Item>
            <Descriptions.Item label="Tác giả">
              {courseDetails.authorName || 'Chưa xác định'}
            </Descriptions.Item>
            <Descriptions.Item label="Người tạo">
              {courseDetails.createdByName || 'Chưa xác định'}
            </Descriptions.Item>
            <Descriptions.Item label="Ngày tạo">
              {moment(courseDetails.createdAt).format('DD/MM/YYYY HH:mm')}
            </Descriptions.Item>
            <Descriptions.Item label="Ngày cập nhật">
              {courseDetails.updatedAt ? moment(courseDetails.updatedAt).format('DD/MM/YYYY HH:mm') : 'Chưa cập nhật'}
            </Descriptions.Item>
            <Descriptions.Item label="Trạng thái">
              <span style={{ 
                color: courseDetails.isActive ? '#52c41a' : '#faad14',
                fontWeight: 'bold'
              }}>
                {courseDetails.isActive ? 'Đã kích hoạt' : 'Chưa kích hoạt'}
              </span>
            </Descriptions.Item>
            <Descriptions.Item label="Tình trạng">
              <span style={{ 
                color: courseDetails.isDelete ? '#ff4d4f' : '#52c41a',
                fontWeight: 'bold'
              }}>
                {courseDetails.isDelete ? 'Đã xóa' : 'Hoạt động'}
              </span>
            </Descriptions.Item>
          </Descriptions>

          {courseDetails.thumbnailUrl && (
            <div style={{ marginTop: 16 }}>
              <Title level={5}>Hình ảnh thumbnail:</Title>
              <Image
                src={courseDetails.thumbnailUrl}
                alt="Course thumbnail"
                style={{ maxWidth: '100%', borderRadius: 8 }}
                fallback="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RUG8OH+QWdgY1YbSXZJM7K7lDOSByNvZOchsH1YLa+Kp7lKvFYuO0GOWFH4Q=="
              />
            </div>
          )}

          {courseDetails.lessons && courseDetails.lessons.length > 0 && (
            <div style={{ marginTop: 16 }}>
              <Divider />
              <Title level={5}>Bài học ({courseDetails.lessons.length})</Title>
              {/* TODO: Implement lessons list */}
              <Text type="secondary">Danh sách bài học sẽ được hiển thị ở đây</Text>
            </div>
          )}
        </div>
      )}

      {/* ✅ Edit/Create Mode - Form */}
      {(isEditing || isCreateMode) && (
        <Form
          form={form}
          layout="vertical"
          onFinish={onFinish}
          initialValues={{
            price: 0,
          }}
        >
          <Form.Item
            name="title"
            label="Tiêu đề"
            rules={[
              { required: true, message: 'Vui lòng nhập tiêu đề khóa học!' },
              { min: 5, message: 'Tiêu đề phải có ít nhất 5 ký tự!' },
              { max: 200, message: 'Tiêu đề không được quá 200 ký tự!' },
            ]}
          >
            <Input placeholder="Nhập tiêu đề khóa học" />
          </Form.Item>

          <Form.Item
            name="description"
            label="Mô tả"
            rules={[
              { max: 1000, message: 'Mô tả không được quá 1000 ký tự!' },
            ]}
          >
            <Input.TextArea 
              rows={4} 
              placeholder="Nhập mô tả khóa học (tùy chọn)"
              showCount
              maxLength={1000}
            />
          </Form.Item>

          <Form.Item
            name="price"
            label="Giá (VND)"
            rules={[
              { required: true, message: 'Vui lòng nhập giá khóa học!' },
              { type: 'number', min: 0, message: 'Giá phải lớn hơn hoặc bằng 0!' },
            ]}
          >
            <InputNumber 
              min={0} 
              style={{ width: '100%' }} 
              placeholder="Nhập giá khóa học"
            />
          </Form.Item>

          <Form.Item
            name="categoryId"
            label="Chủ đề"
            rules={[{ required: true, message: 'Vui lòng chọn chủ đề!' }]}
          >
            <Select placeholder="Chọn chủ đề" allowClear>
              {categories.map(category => (
                <Option key={category.id} value={category.id}>
                  {category.name}
                </Option>
              ))}
            </Select>
          </Form.Item>

          {/* ✅ Thêm dropdown chọn giáo viên */}
          <Form.Item
            name="authorId"
            label="Giáo viên"
            rules={[{ required: true, message: 'Vui lòng chọn giáo viên!' }]}
          >
            <Select 
              placeholder="Chọn giáo viên" 
              allowClear
              showSearch
              filterOption={(input, option) =>
                (option?.children?.toString()?.toLowerCase() ?? '').indexOf(input.toLowerCase()) >= 0
              }
            >
              {teachers.map(teacher => (
                <Option key={teacher.id} value={teacher.id}>
                  {`${teacher.firstName} ${teacher.lastName}`}
                  {teacher.phone && ` - ${teacher.phone}`}
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            name="thumbnail"
            label="Hình ảnh thumbnail"
          >
            <Upload
              fileList={fileList}
              customRequest={handleUpload}
              onRemove={handleRemoveFile}
              maxCount={1}
              accept="image/*"
              showUploadList={{
                showPreviewIcon: true,
                showRemoveIcon: true,
              }}
            >
              <Button 
                icon={<UploadOutlined />} 
                loading={uploadLoading}
                disabled={fileList.length >= 1}
              >
                {fileList.length >= 1 ? 'Đã tải lên' : 'Tải ảnh lên'}
              </Button>
            </Upload>
            <div style={{ marginTop: 8, fontSize: 12, color: '#666' }}>
              Chỉ chấp nhận file hình ảnh, kích thước tối đa 5MB
            </div>
          </Form.Item>

          {thumbnailUrl && (
            <Form.Item label="Xem trước">
              <Image 
                src={thumbnailUrl} 
                alt="Thumbnail preview" 
                style={{ 
                  maxWidth: '100%', 
                  borderRadius: 4,
                  border: '1px solid #d9d9d9'
                }} 
              />
            </Form.Item>
          )}
        </Form>
      )}
    </Drawer>
  );
};

export default CourseDetailDrawer;.ant-drawer-content-wrapper {
  padding: 16px;
}

.ant-drawer .ant-form-item {
  margin-bottom: 16px;
}

.ant-drawer .ant-btn {
  width: 100%;
}import { message } from "antd";
import { rolePermissions } from "../../../constants/permissions";
import { Navigate, Outlet } from "react-router-dom";
import useAuthStore from "store/authStore";
import'./ProtectedRoute.css'
import 'antd/dist/reset.css'

interface ProtectedRouteProps{
  allowedTab: string;
}

const ProtectedRoute = ({allowedTab} : ProtectedRouteProps) => {
  const {user, isAuthenticated} = useAuthStore();
  
  if(!isAuthenticated) {
    message.error('Đăng nhập đã brooo!');
    return <Navigate to="/" replace/>;
  }

  const userRole = user?.role || ' ';
  const hasPermission = rolePermissions[userRole].includes(allowedTab);
  
  if(!hasPermission){
    message.error('Quyền là gì mà là quyền ai chấm');
    console.log('hahaha');
    
    // return <Navigate to="/" replace/>;
  }

  return (
    // <div className="protected-route">
      <Outlet/>
    // </div>
  )
}



export default ProtectedRouteimport { useState } from 'react';
import { UserOutlined, LogoutOutlined, BookOutlined } from '@ant-design/icons';
import { Dropdown, type MenuProps } from 'antd';
import { Link, useNavigate } from 'react-router-dom';
import useAuthStore from '../../../store/authStore';
import './UserMenu.css';
import useCartStore from 'store/cartStore';

const UserMenu = () => {
  const { user, logout } = useAuthStore();
  const {clearCart } = useCartStore();
  const navigate = useNavigate();
  const [isOpen, setIsOpen] = useState(false);

  const items: MenuProps['items'] = [
    {
      key: 'dashboard',
      icon: <UserOutlined />,
      label: <Link to="/dashboard/profile">Thông tin cá nhân</Link>,
    },
    {
      key: 'courses',
      icon: <BookOutlined />,
      label: <Link to={`/${user?.role}/dashboard`}>Khóa học của tôi</Link>,
    },
    {
      key: 'logout',
      icon: <LogoutOutlined />,
      label: 'Đăng xuất',
      onClick: () => {
        logout();
        navigate('/');
        clearCart();
      },
    },
  ];

  return (
    <Dropdown
      menu={{ items }}
      trigger={['hover']}
      open={isOpen}
      onOpenChange={(open) => setIsOpen(open)}
    >
      <UserOutlined className="user-icon" />
    </Dropdown>
  );
};

export default UserMenu;import api from '../lib/axios';
import type { FilterRequest, FilterResponse, DisableUserRequest, DisableUserResponse, DeleteUserRequest, DeleteUserResponse, UserProfileResponse, UpdateUserInfoRequest, UpdateUserInfoResponse } from '../types/user';

export const filterUsers = async (data: FilterRequest): Promise<FilterResponse> => {
  const response = await api.post('/api/v1/user/filter', data, {
    params: {
      page: data.page || 0,
      size: data.size || 10,
      sort: data.sort || undefined,
    },
  });
  return response.data;
};

export const disableUser = async (data: DisableUserRequest): Promise<DisableUserResponse> => {
  const response = await api.post('/api/v1/user/disable-user', data);
  return response.data;
};

export const deleteUser = async (data: DeleteUserRequest): Promise<DeleteUserResponse> => {
  const response = await api.post('/api/v1/user/delete-user', data);
  return response.data;
};

export const getUserProfile = async (): Promise<UserProfileResponse> => {
  const response = await api.get('/api/v1/user');
  return response.data;
};

export const updateUserInfo = async (data: UpdateUserInfoRequest): Promise<UpdateUserInfoResponse> => {
  const response = await api.post('/api/v1/user/update-own-info', data);
  return response.data;
};import api from 'lib/axios';
import type { PaymentResponse } from 'types/payment';

export const createPayment = async (orderId: number): Promise<PaymentResponse> => {
  const response = await api.get('api/v1/payment/create',{
    params: {orderId}
  });
  return response.data;
}// api/order/orderApi.ts
import api from '../lib/axios';
import type { 
  OrderResponse, 
  CreateOrderResponse, 
  DeleteOrderResponse 
} from '../types/order';

export const createOrderByCourse = async (courseId: number): Promise<CreateOrderResponse> => {
  const response = await api.post('/api/v1/order/create-order-by-course', null, {
    params: { id: courseId }  // courseId đi qua query parameter
  });
  return response.data;
};

export const createOrderByCartItem = async (cartItemId: number): Promise<CreateOrderResponse> => {
  const response = await api.post('/api/v1/order/create-order-by-cart-item', null, {
    params: { id: cartItemId }  // cartItemId đi qua query parameter
  });
  return response.data;
};


export const getOrders = async (): Promise<OrderResponse> => {
  const response = await api.get('/api/v1/order');
  return response.data;
};

export const deleteOrder = async (orderId: number): Promise<DeleteOrderResponse> => {
  const response = await api.delete('/api/v1/order/delete', {
    params: { id: orderId }  // orderId đi qua query parameter
  });
  return response.data;
};// api/course/courseApi.ts - Cải thiện
import api from '../lib/axios';
import type { 
  AllCoursesRequest, 
  CourseResponse, 
  CourseDetailResponse, 
  CourseCreateRequest, 
  CourseUpdateRequest, 
  CourseStatusUpdateRequest, // ✅ Thêm type mới
  UploadResponse, 
  CategoryResponse 
} from '../types/course';

export const getAllCourses = async (data: AllCoursesRequest): Promise<CourseResponse> => {
  const response = await api.post('/api/v1/course/all-courses', data, {
    params: {
      page: data.page || 0,
      size: data.size || 10,
      sort: data.sort || undefined,
    },
  });
  return response.data;
};

// ✅ Sửa getCourseById để dùng GET với query parameter
export const getCourseById = async (id: number): Promise<CourseDetailResponse> => {
  const response = await api.get('/api/v1/course', {
    params: { id }
  });
  return response.data;
};

export const createCourse = async (data: CourseCreateRequest): Promise<CourseDetailResponse> => {
  const response = await api.post('/api/v1/course/create', data);
  return response.data;
};

export const updateCourseInfo = async (data: CourseUpdateRequest): Promise<CourseDetailResponse> => {
  const response = await api.post('/api/v1/course/update-info', data);
  return response.data;
};

// ✅ Tách riêng endpoint cho update status
export const updateCourseStatus = async (data: CourseStatusUpdateRequest): Promise<CourseDetailResponse> => {
  const response = await api.post('/api/v1/course/update-status', data);
  return response.data;
};

export const uploadImage = async (formData: FormData): Promise<UploadResponse> => {
  const response = await api.post('/api/v1/cloud/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
  return response.data;
};

// ✅ Sửa endpoint cho course categories
export const getCategories = async (): Promise<CategoryResponse> => {
  const response = await api.get('/api/v1/category/course'); // ✅ Đổi từ /post sang /course
  return response.data;
};import api from "../lib/axios";
import type { AddToCartResponse, CartResponse, RemoveFromCartResponse } from "types/cart";

export const addToCart = async (courseId: number): Promise<AddToCartResponse> => {
  const response = await api.post(
    '/api/v1/cart/add-to-cart', 
    null,
    {
      params: {id: courseId}
    }
  )
  return response.data;
}

export const getCart = async (): Promise<CartResponse> => {
  const response = await api.get('/api/v1/cart');
  return response.data;
};

export const removeFromCart = async (cartItemId: number): Promise<RemoveFromCartResponse> => {
  const response = await api.delete('/api/v1/cart/remove-from-cart', {
    params: { id: cartItemId }
  });
  return response.data;
};

//API ko có clear thì e hoàng tự làm tạm hehe
export const clearCart = async (cartItemIds: number[]): Promise<void> => {
  const promises = cartItemIds.map(itemId => removeFromCart(itemId));
  await Promise.all(promises);
};
import api from '../lib/axios';
import type { PostData, PostResponse, UploadResponse, AllPostsRequest, AllPostsResponse, UpdateStatusRequest, UpdateStatusResponse, CategoryResponse } from '../types/blog';

export const createPost = async (data: PostData): Promise<PostResponse> => {
  const response = await api.post('/api/v1/post/create', data);
  return response.data;
};

export const uploadImage = async (formData: FormData): Promise<UploadResponse> => {
  const response = await api.post('/api/v1/cloud/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
  return response.data;
};

export const getAllPosts = async (data: AllPostsRequest): Promise<AllPostsResponse> => {
  const response = await api.post('/api/v1/post/all-posts', 
    data,
    {params: {
      page: data.page || 0,
      size: data.size || 10,
      sort: data.sort || undefined,
    }}
  );
  return response.data;
};

export const updatePostStatus = async (data: UpdateStatusRequest): Promise<UpdateStatusResponse> => {
  const response = await api.post('/api/v1/post/update-status', data);
  return response.data;
};

export const getCategories = async (): Promise<CategoryResponse> => {
  const response = await api.get('/api/v1/category/post');
  return response.data;
};import type { UserProfileResponse } from 'types/user';
import api from '../lib/axios';
import type { RegisterRequest, LoginRequest, AuthResponse, LogoutResponse, UpdatePasswordRequest } from '../types/auth';

export const register = async (data: RegisterRequest): Promise<LogoutResponse> => {
  const response = await api.post('/api/v1/auth/register', data);
  return response.data;
};

export const login = async (data: LoginRequest): Promise<AuthResponse> => {
  const response = await api.post('/api/v1/auth/login', data);
  return response.data;
};

export const logout = async (): Promise<LogoutResponse> => {
  const response = await api.get('/api/v1/auth/logout');
  return response.data;
};

export const refreshToken = async (): Promise<AuthResponse> => {
  const response = await api.get('/api/v1/auth/refresh');
  return response.data;
};


export const updatePassword = async(data: UpdatePasswordRequest): Promise<UserProfileResponse> => {
  const response = await api.post('/api/v1/user/update-own-info', data);
  return response.data;
}